cscope 15 $HOME/.src/ldd/scull -q 0000000367 0000030742
	@access.c

20 
	~<löux/kî√l.h
>

21 
	~<löux/moduÀ.h
>

22 
	~<löux/¶ab.h
>

23 
	~<löux/fs.h
>

24 
	~<löux/î∫o.h
>

25 
	~<löux/ty≥s.h
>

26 
	~<löux/f˙é.h
>

27 
	~<löux/cdev.h
>

28 
	~<löux/ây.h
>

29 
	~<asm/©omic.h
>

30 
	~<löux/li°.h
>

32 
	~"scuŒ.h
"

34 
dev_t
 
	gscuŒ_a_fú°dev
;

49 
scuŒ_dev
 
	gscuŒ_s_devi˚
;

50 
©omic_t
 
	gscuŒ_s_avaûabÀ
 = 
ATOMIC_INIT
(1);

52 
	$scuŒ_s_›í
(
öode
 *öode, 
fûe
 *
fûp
)

54 
scuŒ_dev
 *
dev
 = &
scuŒ_s_devi˚
;

56 i‡(! 
	`©omic_dec_™d_ã°
 (&
scuŒ_s_avaûabÀ
)) {

57 
	`©omic_öc
(&
scuŒ_s_avaûabÀ
);

58  -
EBUSY
;

62 i‡–(
fûp
->
f_Êags
 & 
O_ACCMODE
Ë=
O_WRONLY
)

63 
	`scuŒ_åim
(
dev
);

64 
fûp
->
¥iv©e_d©a
 = 
dev
;

66 
	}
}

68 
	$scuŒ_s_ªÀa£
(
öode
 *öode, 
fûe
 *
fûp
)

70 
	`©omic_öc
(&
scuŒ_s_avaûabÀ
);

72 
	}
}

78 
fûe_›î©i⁄s
 
	gscuŒ_¢gl_f›s
 = {

79 .
ow√r
 = 
THIS_MODULE
,

80 .
	gŒ£ek
 = 
scuŒ_Œ£ek
,

81 .
	gªad
 = 
scuŒ_ªad
,

82 .
	gwrôe
 = 
scuŒ_wrôe
,

83 .
	gio˘l
 = 
scuŒ_io˘l
,

84 .
	g›í
 = 
scuŒ_s_›í
,

85 .
	gªÀa£
 = 
scuŒ_s_ªÀa£
,

95 
scuŒ_dev
 
	gscuŒ_u_devi˚
;

96 
	gscuŒ_u_cou¡
;

97 
uid_t
 
	gscuŒ_u_ow√r
;

98 
•ölock_t
 
	gscuŒ_u_lock
 = 
SPIN_LOCK_UNLOCKED
;

100 
	$scuŒ_u_›í
(
öode
 *öode, 
fûe
 *
fûp
)

102 
scuŒ_dev
 *
dev
 = &
scuŒ_u_devi˚
;

104 
	`•ö_lock
(&
scuŒ_u_lock
);

105 i‡(
scuŒ_u_cou¡
 &&

106 (
scuŒ_u_ow√r
 !
cuºít
->
uid
) &&

107 (
scuŒ_u_ow√r
 !
cuºít
->
euid
) &&

108 !
	`ˇ∑bÀ
(
CAP_DAC_OVERRIDE
)) {

109 
	`•ö_u∆ock
(&
scuŒ_u_lock
);

110  -
EBUSY
;

113 i‡(
scuŒ_u_cou¡
 == 0)

114 
scuŒ_u_ow√r
 = 
cuºít
->
uid
;

116 
scuŒ_u_cou¡
++;

117 
	`•ö_u∆ock
(&
scuŒ_u_lock
);

121 i‡((
fûp
->
f_Êags
 & 
O_ACCMODE
Ë=
O_WRONLY
)

122 
	`scuŒ_åim
(
dev
);

123 
fûp
->
¥iv©e_d©a
 = 
dev
;

125 
	}
}

127 
	$scuŒ_u_ªÀa£
(
öode
 *öode, 
fûe
 *
fûp
)

129 
	`•ö_lock
(&
scuŒ_u_lock
);

130 
scuŒ_u_cou¡
--;

131 
	`•ö_u∆ock
(&
scuŒ_u_lock
);

133 
	}
}

140 
fûe_›î©i⁄s
 
	gscuŒ_u£r_f›s
 = {

141 .
ow√r
 = 
THIS_MODULE
,

142 .
	gŒ£ek
 = 
scuŒ_Œ£ek
,

143 .
	gªad
 = 
scuŒ_ªad
,

144 .
	gwrôe
 = 
scuŒ_wrôe
,

145 .
	gio˘l
 = 
scuŒ_io˘l
,

146 .
	g›í
 = 
scuŒ_u_›í
,

147 .
	gªÀa£
 = 
scuŒ_u_ªÀa£
,

156 
scuŒ_dev
 
	gscuŒ_w_devi˚
;

157 
	gscuŒ_w_cou¡
;

158 
uid_t
 
	gscuŒ_w_ow√r
;

159 
DECLARE_WAIT_QUEUE_HEAD
(
scuŒ_w_waô
);

160 
•ölock_t
 
	gscuŒ_w_lock
 = 
SPIN_LOCK_UNLOCKED
;

162 
ölöe
 
	$scuŒ_w_avaûabÀ
()

164  
scuŒ_w_cou¡
 == 0 ||

165 
scuŒ_w_ow√r
 =
cuºít
->
uid
 ||

166 
scuŒ_w_ow√r
 =
cuºít
->
euid
 ||

167 
	`ˇ∑bÀ
(
CAP_DAC_OVERRIDE
);

168 
	}
}

171 
	$scuŒ_w_›í
(
öode
 *öode, 
fûe
 *
fûp
)

173 
scuŒ_dev
 *
dev
 = &
scuŒ_w_devi˚
;

175 
	`•ö_lock
(&
scuŒ_w_lock
);

176 ! 
	`scuŒ_w_avaûabÀ
()) {

177 
	`•ö_u∆ock
(&
scuŒ_w_lock
);

178 i‡(
fûp
->
f_Êags
 & 
O_NONBLOCK
Ë -
EAGAIN
;

179 i‡(
	`waô_evít_öãºu±ibÀ
 (
scuŒ_w_waô
, 
	`scuŒ_w_avaûabÀ
()))

180  -
ERESTARTSYS
;

181 
	`•ö_lock
(&
scuŒ_w_lock
);

183 i‡(
scuŒ_w_cou¡
 == 0)

184 
scuŒ_w_ow√r
 = 
cuºít
->
uid
;

185 
scuŒ_w_cou¡
++;

186 
	`•ö_u∆ock
(&
scuŒ_w_lock
);

189 i‡((
fûp
->
f_Êags
 & 
O_ACCMODE
Ë=
O_WRONLY
)

190 
	`scuŒ_åim
(
dev
);

191 
fûp
->
¥iv©e_d©a
 = 
dev
;

193 
	}
}

195 
	$scuŒ_w_ªÀa£
(
öode
 *öode, 
fûe
 *
fûp
)

197 
ãmp
;

199 
	`•ö_lock
(&
scuŒ_w_lock
);

200 
scuŒ_w_cou¡
--;

201 
ãmp
 = 
scuŒ_w_cou¡
;

202 
	`•ö_u∆ock
(&
scuŒ_w_lock
);

204 i‡(
ãmp
 == 0)

205 
	`wake_up_öãºu±ibÀ_sync
(&
scuŒ_w_waô
);

207 
	}
}

213 
fûe_›î©i⁄s
 
	gscuŒ_wu§_f›s
 = {

214 .
ow√r
 = 
THIS_MODULE
,

215 .
	gŒ£ek
 = 
scuŒ_Œ£ek
,

216 .
	gªad
 = 
scuŒ_ªad
,

217 .
	gwrôe
 = 
scuŒ_wrôe
,

218 .
	gio˘l
 = 
scuŒ_io˘l
,

219 .
	g›í
 = 
scuŒ_w_›í
,

220 .
	gªÀa£
 = 
scuŒ_w_ªÀa£
,

231 
	sscuŒ_li°ôem
 {

232 
scuŒ_dev
 
	mdevi˚
;

233 
dev_t
 
	mkey
;

234 
li°_hód
 
	mli°
;

239 
LIST_HEAD
(
scuŒ_c_li°
);

240 
•ölock_t
 
	gscuŒ_c_lock
 = 
SPIN_LOCK_UNLOCKED
;

243 
scuŒ_dev
 
	gscuŒ_c_devi˚
;

246 
scuŒ_dev
 *
	$scuŒ_c_lookf‹_devi˚
(
dev_t
 
key
)

248 
scuŒ_li°ôem
 *
Õå
;

250 
	`li°_f‹_óch_íåy
(
Õå
, &
scuŒ_c_li°
, 
li°
) {

251 i‡(
Õå
->
key
 == key)

252  &(
Õå
->
devi˚
);

256 
Õå
 = 
	`kmÆloc
((
scuŒ_li°ôem
), 
GFP_KERNEL
);

257 i‡(!
Õå
)

258  
NULL
;

261 
	`mem£t
(
Õå
, 0, (
scuŒ_li°ôem
));

262 
Õå
->
key
 = key;

263 
	`scuŒ_åim
(&(
Õå
->
devi˚
));

264 
	`öô_MUTEX
(&(
Õå
->
devi˚
.
£m
));

267 
	`li°_add
(&
Õå
->
li°
, &
scuŒ_c_li°
);

269  &(
Õå
->
devi˚
);

270 
	}
}

272 
	$scuŒ_c_›í
(
öode
 *öode, 
fûe
 *
fûp
)

274 
scuŒ_dev
 *
dev
;

275 
dev_t
 
key
;

277 i‡(!
cuºít
->
sig«l
->
ây
) {

278 
	`PDEBUG
("Pro˚s†\"%s\" ha†nÿ˘»ây\n", 
cuºít
->
comm
);

279  -
EINVAL
;

281 
key
 = 
	`ây_devnum
(
cuºít
->
sig«l
->
ây
);

284 
	`•ö_lock
(&
scuŒ_c_lock
);

285 
dev
 = 
	`scuŒ_c_lookf‹_devi˚
(
key
);

286 
	`•ö_u∆ock
(&
scuŒ_c_lock
);

288 i‡(!
dev
)

289  -
ENOMEM
;

292 i‡–(
fûp
->
f_Êags
 & 
O_ACCMODE
Ë=
O_WRONLY
)

293 
	`scuŒ_åim
(
dev
);

294 
fûp
->
¥iv©e_d©a
 = 
dev
;

296 
	}
}

298 
	$scuŒ_c_ªÀa£
(
öode
 *öode, 
fûe
 *
fûp
)

305 
	}
}

312 
fûe_›î©i⁄s
 
	gscuŒ_¥iv_f›s
 = {

313 .
ow√r
 = 
THIS_MODULE
,

314 .
	gŒ£ek
 = 
scuŒ_Œ£ek
,

315 .
	gªad
 = 
scuŒ_ªad
,

316 .
	gwrôe
 = 
scuŒ_wrôe
,

317 .
	gio˘l
 = 
scuŒ_io˘l
,

318 .
	g›í
 = 
scuŒ_c_›í
,

319 .
	gªÀa£
 = 
scuŒ_c_ªÀa£
,

327 
	sscuŒ_adev_öfo
 {

328 *
	m«me
;

329 
scuŒ_dev
 *
	mscuŒdev
;

330 
fûe_›î©i⁄s
 *
	mf›s
;

331 } 
	gscuŒ_ac˚ss_devs
[] = {

332 { "scuŒsögÀ", &
scuŒ_s_devi˚
, &
scuŒ_¢gl_f›s
 },

333 { "scuŒuid", &
scuŒ_u_devi˚
, &
scuŒ_u£r_f›s
 },

334 { "scuŒwuid", &
scuŒ_w_devi˚
, &
scuŒ_wu§_f›s
 },

335 { "suŒ¥iv", &
scuŒ_c_devi˚
, &
scuŒ_¥iv_f›s
 }

337 
	#SCULL_N_ADEVS
 4

	)

342 
	$scuŒ_ac˚ss_£tup
 (
dev_t
 
devno
, 
scuŒ_adev_öfo
 *
devöfo
)

344 
scuŒ_dev
 *
dev
 = 
devöfo
->
scuŒdev
;

345 
îr
;

348 
dev
->
qu™tum
 = 
scuŒ_qu™tum
;

349 
dev
->
q£t
 = 
scuŒ_q£t
;

350 
	`öô_MUTEX
(&
dev
->
£m
);

353 
	`cdev_öô
(&
dev
->
cdev
, 
devöfo
->
f›s
);

354 
	`kobje˘_£t_«me
(&
dev
->
cdev
.
kobj
, 
devöfo
->
«me
);

355 
dev
->
cdev
.
ow√r
 = 
THIS_MODULE
;

356 
îr
 = 
	`cdev_add
 (&
dev
->
cdev
, 
devno
, 1);

358 i‡(
îr
) {

359 
	`¥ötk
(
KERN_NOTICE
 "Eº‹ %dáddög %s\n", 
îr
, 
devöfo
->
«me
);

360 
	`kobje˘_put
(&
dev
->
cdev
.
kobj
);

362 
	`¥ötk
(
KERN_NOTICE
 "%†ªgi°îedáà%x\n", 
devöfo
->
«me
, 
devno
);

363 
	}
}

366 
	$scuŒ_ac˚ss_öô
(
dev_t
 
fú°dev
)

368 
ªsu…
, 
i
;

371 
ªsu…
 = 
	`ªgi°î_chrdev_ªgi⁄
 (
fú°dev
, 
SCULL_N_ADEVS
, "sculla");

372 i‡(
ªsu…
 < 0) {

373 
	`¥ötk
(
KERN_WARNING
 "sculla: deviceÇumberÑegistration failed\n");

376 
scuŒ_a_fú°dev
 = 
fú°dev
;

379 
i
 = 0; i < 
SCULL_N_ADEVS
; i++)

380 
	`scuŒ_ac˚ss_£tup
 (
fú°dev
 + 
i
, 
scuŒ_ac˚ss_devs
 + i);

381  
SCULL_N_ADEVS
;

382 
	}
}

388 
	$scuŒ_ac˚ss_˛ónup
()

390 
scuŒ_li°ôem
 *
Õå
, *
√xt
;

391 
i
;

394 
i
 = 0; i < 
SCULL_N_ADEVS
; i++) {

395 
scuŒ_dev
 *
dev
 = 
scuŒ_ac˚ss_devs
[
i
].
scuŒdev
;

396 
	`cdev_dñ
(&
dev
->
cdev
);

397 
	`scuŒ_åim
(
scuŒ_ac˚ss_devs
[
i
].
scuŒdev
);

401 
	`li°_f‹_óch_íåy_ß„
(
Õå
, 
√xt
, &
scuŒ_c_li°
, 
li°
) {

402 
	`li°_dñ
(&
Õå
->
li°
);

403 
	`scuŒ_åim
(&(
Õå
->
devi˚
));

404 
	`k‰ì
(
Õå
);

408 
	`uƒegi°î_chrdev_ªgi⁄
(
scuŒ_a_fú°dev
, 
SCULL_N_ADEVS
);

410 
	}
}

	@main.c

17 
	~<löux/c⁄fig.h
>

18 
	~<löux/moduÀ.h
>

19 
	~<löux/moduÀ∑øm.h
>

20 
	~<löux/öô.h
>

22 
	~<löux/kî√l.h
>

23 
	~<löux/¶ab.h
>

24 
	~<löux/fs.h
>

25 
	~<löux/î∫o.h
>

26 
	~<löux/ty≥s.h
>

27 
	~<löux/¥oc_fs.h
>

28 
	~<löux/f˙é.h
>

29 
	~<löux/£q_fûe.h
>

30 
	~<löux/cdev.h
>

32 
	~<asm/sy°em.h
>

33 
	~<asm/uac˚ss.h
>

35 
	~"scuŒ.h
"

41 
	gscuŒ_maj‹
 = 
SCULL_MAJOR
;

42 
	gscuŒ_mö‹
 = 0;

43 
	gscuŒ_ƒ_devs
 = 
SCULL_NR_DEVS
;

44 
	gscuŒ_qu™tum
 = 
SCULL_QUANTUM
;

45 
	gscuŒ_q£t
 = 
SCULL_QSET
;

47 
moduÀ_∑øm
(
scuŒ_maj‹
, , 
S_IRUGO
);

48 
moduÀ_∑øm
(
scuŒ_mö‹
, , 
S_IRUGO
);

49 
moduÀ_∑øm
(
scuŒ_ƒ_devs
, , 
S_IRUGO
);

50 
moduÀ_∑øm
(
scuŒ_qu™tum
, , 
S_IRUGO
);

51 
moduÀ_∑øm
(
scuŒ_q£t
, , 
S_IRUGO
);

53 
MODULE_AUTHOR
("Alessandro Rubini, Jonathan Corbet");

54 
MODULE_LICENSE
("Dual BSD/GPL");

56 
scuŒ_dev
 *
	gscuŒ_devi˚s
;

63 
	$scuŒ_åim
(
scuŒ_dev
 *
dev
)

65 
scuŒ_q£t
 *
√xt
, *
d±r
;

66 
q£t
 = 
dev
->qset;

67 
i
;

69 
d±r
 = 
dev
->
d©a
; d±r; d±∏
√xt
) {

70 i‡(
d±r
->
d©a
) {

71 
i
 = 0; i < 
q£t
; i++)

72 
	`k‰ì
(
d±r
->
d©a
[
i
]);

73 
	`k‰ì
(
d±r
->
d©a
);

74 
d±r
->
d©a
 = 
NULL
;

76 
√xt
 = 
d±r
->next;

77 
	`k‰ì
(
d±r
);

79 
dev
->
size
 = 0;

80 
dev
->
qu™tum
 = 
scuŒ_qu™tum
;

81 
dev
->
q£t
 = 
scuŒ_q£t
;

82 
dev
->
d©a
 = 
NULL
;

84 
	}
}

85 #ifde‡
SCULL_DEBUG


90 
	$scuŒ_ªad_¥ocmem
(*
buf
, **
°¨t
, 
off_t
 
off£t
,

91 
cou¡
, *
eof
, *
d©a
)

93 
i
, 
j
, 
Àn
 = 0;

94 
limô
 = 
cou¡
 - 80;

96 
i
 = 0; i < 
scuŒ_ƒ_devs
 && 
Àn
 <
limô
; i++) {

97 
scuŒ_dev
 *
d
 = &
scuŒ_devi˚s
[
i
];

98 
scuŒ_q£t
 *
qs
 = 
d
->
d©a
;

99 i‡(
	`down_öãºu±ibÀ
(&
d
->
£m
))

100  -
ERESTARTSYS
;

101 
Àn
 +
	`•rötf
(
buf
+len,"\nDevice %i: qset %i, q %i, sz %li\n",

102 
i
, 
d
->
q£t
, d->
qu™tum
, d->
size
);

103 ; 
qs
 && 
Àn
 <
limô
; q†qs->
√xt
) {

104 
Àn
 +
	`•rötf
(
buf
 +Üen, " itemát %p, qsetát %p\n",

105 
qs
, qs->
d©a
);

106 i‡(
qs
->
d©a
 && !qs->
√xt
)

107 
j
 = 0; j < 
d
->
q£t
; j++) {

108 i‡(
qs
->
d©a
[
j
])

109 
Àn
 +
	`•rötf
(
buf
 +Üen,

111 
j
, 
qs
->
d©a
[j]);

114 
	`up
(&
scuŒ_devi˚s
[
i
].
£m
);

116 *
eof
 = 1;

117  
Àn
;

118 
	}
}

130 *
	$scuŒ_£q_°¨t
(
£q_fûe
 *
s
, 
loff_t
 *
pos
)

132 i‡(*
pos
 >
scuŒ_ƒ_devs
)

133  
NULL
;

134  
scuŒ_devi˚s
 + *
pos
;

135 
	}
}

137 *
	$scuŒ_£q_√xt
(
£q_fûe
 *
s
, *
v
, 
loff_t
 *
pos
)

139 (*
pos
)++;

140 i‡(*
pos
 >
scuŒ_ƒ_devs
)

141  
NULL
;

142  
scuŒ_devi˚s
 + *
pos
;

143 
	}
}

145 
	$scuŒ_£q_°›
(
£q_fûe
 *
s
, *
v
)

148 
	}
}

150 
	$scuŒ_£q_show
(
£q_fûe
 *
s
, *
v
)

152 
scuŒ_dev
 *
dev
 = (scuŒ_dev *Ë
v
;

153 
scuŒ_q£t
 *
d
;

154 
i
;

156 i‡(
	`down_öãºu±ibÀ
(&
dev
->
£m
))

157  -
ERESTARTSYS
;

158 
	`£q_¥ötf
(
s
, "\nDevice %i: qset %i, q %i, sz %li\n",

159 (Ë(
dev
 - 
scuŒ_devi˚s
), dev->
q£t
,

160 
dev
->
qu™tum
, dev->
size
);

161 
d
 = 
dev
->
d©a
; d; d = d->
√xt
) {

162 
	`£q_¥ötf
(
s
, " iãmáà%p, q£à© %p\n", 
d
, d->
d©a
);

163 i‡(
d
->
d©a
 && !d->
√xt
)

164 
i
 = 0; i < 
dev
->
q£t
; i++) {

165 i‡(
d
->
d©a
[
i
])

166 
	`£q_¥ötf
(
s
, " % 4i: %8p\n",

167 
i
, 
d
->
d©a
[i]);

170 
	`up
(&
dev
->
£m
);

172 
	}
}

177 
£q_›î©i⁄s
 
	gscuŒ_£q_›s
 = {

178 .
°¨t
 = 
scuŒ_£q_°¨t
,

179 .
	g√xt
 = 
scuŒ_£q_√xt
,

180 .
	g°›
 = 
scuŒ_£q_°›
,

181 .
	gshow
 = 
scuŒ_£q_show


188 
	$scuŒ_¥oc_›í
(
öode
 *öode, 
fûe
 *file)

190  
	`£q_›í
(
fûe
, &
scuŒ_£q_›s
);

191 
	}
}

196 
fûe_›î©i⁄s
 
	gscuŒ_¥oc_›s
 = {

197 .
ow√r
 = 
THIS_MODULE
,

198 .
	g›í
 = 
scuŒ_¥oc_›í
,

199 .
	gªad
 = 
£q_ªad
,

200 .
	gŒ£ek
 = 
£q_l£ek
,

201 .
	gªÀa£
 = 
£q_ªÀa£


209 
	$scuŒ_¸óã_¥oc
()

211 
¥oc_dú_íåy
 *
íåy
;

212 
	`¸óã_¥oc_ªad_íåy
("scullmem", 0 ,

213 
NULL
 , 
scuŒ_ªad_¥ocmem
,

214 
NULL
 );

215 
íåy
 = 
	`¸óã_¥oc_íåy
("scuŒ£q", 0, 
NULL
);

216 i‡(
íåy
)

217 
íåy
->
¥oc_f›s
 = &
scuŒ_¥oc_›s
;

218 
	}
}

220 
	$scuŒ_ªmove_¥oc
()

223 
	`ªmove_¥oc_íåy
("scuŒmem", 
NULL
 );

224 
	`ªmove_¥oc_íåy
("scuŒ£q", 
NULL
);

225 
	}
}

238 
	$scuŒ_›í
(
öode
 *öode, 
fûe
 *
fûp
)

240 
scuŒ_dev
 *
dev
;

242 
dev
 = 
	`c⁄èöî_of
(
öode
->
i_cdev
, 
scuŒ_dev
, 
cdev
);

243 
fûp
->
¥iv©e_d©a
 = 
dev
;

246 i‡–(
fûp
->
f_Êags
 & 
O_ACCMODE
Ë=
O_WRONLY
) {

247 i‡(
	`down_öãºu±ibÀ
(&
dev
->
£m
))

248  -
ERESTARTSYS
;

249 
	`scuŒ_åim
(
dev
);

250 
	`up
(&
dev
->
£m
);

253 
	}
}

255 
	$scuŒ_ªÀa£
(
öode
 *öode, 
fûe
 *
fûp
)

258 
	}
}

262 
scuŒ_q£t
 *
	$scuŒ_fﬁlow
(
scuŒ_dev
 *
dev
, 
n
)

264 
scuŒ_q£t
 *
qs
 = 
dev
->
d©a
;

267 i‡(! 
qs
) {

268 
qs
 = 
dev
->
d©a
 = 
	`kmÆloc
((
scuŒ_q£t
), 
GFP_KERNEL
);

269 i‡(
qs
 =
NULL
)

270  
NULL
;

271 
	`mem£t
(
qs
, 0, (
scuŒ_q£t
));

275 
n
--) {

276 i‡(!
qs
->
√xt
) {

277 
qs
->
√xt
 = 
	`kmÆloc
((
scuŒ_q£t
), 
GFP_KERNEL
);

278 i‡(
qs
->
√xt
 =
NULL
)

279  
NULL
;

280 
	`mem£t
(
qs
->
√xt
, 0, (
scuŒ_q£t
));

282 
qs
 = qs->
√xt
;

285  
qs
;

286 
	}
}

292 
ssize_t
 
	$scuŒ_ªad
(
fûe
 *
fûp
, 
__u£r
 *
buf
, 
size_t
 
cou¡
,

293 
loff_t
 *
f_pos
)

295 
scuŒ_dev
 *
dev
 = 
fûp
->
¥iv©e_d©a
;

296 
scuŒ_q£t
 *
d±r
;

297 
qu™tum
 = 
dev
->qu™tum, 
q£t
 = dev->qset;

298 
ôemsize
 = 
qu™tum
 * 
q£t
;

299 
ôem
, 
s_pos
, 
q_pos
, 
ª°
;

300 
ssize_t
 
ªtvÆ
 = 0;

302 i‡(
	`down_öãºu±ibÀ
(&
dev
->
£m
))

303  -
ERESTARTSYS
;

304 i‡(*
f_pos
 >
dev
->
size
)

305 
out
;

306 i‡(*
f_pos
 + 
cou¡
 > 
dev
->
size
)

307 
cou¡
 = 
dev
->
size
 - *
f_pos
;

310 
ôem
 = ()*
f_pos
 / 
ôemsize
;

311 
ª°
 = ()*
f_pos
 % 
ôemsize
;

312 
s_pos
 = 
ª°
 / 
qu™tum
; 
q_pos
 =Ñest % quantum;

315 
d±r
 = 
	`scuŒ_fﬁlow
(
dev
, 
ôem
);

317 i‡(
d±r
 =
NULL
 || !d±r->
d©a
 || ! d±r->d©a[
s_pos
])

318 
out
;

321 i‡(
cou¡
 > 
qu™tum
 - 
q_pos
)

322 
cou¡
 = 
qu™tum
 - 
q_pos
;

324 i‡(
	`c›y_to_u£r
(
buf
, 
d±r
->
d©a
[
s_pos
] + 
q_pos
, 
cou¡
)) {

325 
ªtvÆ
 = -
EFAULT
;

326 
out
;

328 *
f_pos
 +
cou¡
;

329 
ªtvÆ
 = 
cou¡
;

331 
out
:

332 
	`up
(&
dev
->
£m
);

333  
ªtvÆ
;

334 
	}
}

336 
ssize_t
 
	$scuŒ_wrôe
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
, 
size_t
 
cou¡
,

337 
loff_t
 *
f_pos
)

339 
scuŒ_dev
 *
dev
 = 
fûp
->
¥iv©e_d©a
;

340 
scuŒ_q£t
 *
d±r
;

341 
qu™tum
 = 
dev
->qu™tum, 
q£t
 = dev->qset;

342 
ôemsize
 = 
qu™tum
 * 
q£t
;

343 
ôem
, 
s_pos
, 
q_pos
, 
ª°
;

344 
ssize_t
 
ªtvÆ
 = -
ENOMEM
;

346 i‡(
	`down_öãºu±ibÀ
(&
dev
->
£m
))

347  -
ERESTARTSYS
;

350 
ôem
 = ()*
f_pos
 / 
ôemsize
;

351 
ª°
 = ()*
f_pos
 % 
ôemsize
;

352 
s_pos
 = 
ª°
 / 
qu™tum
; 
q_pos
 =Ñest % quantum;

355 
d±r
 = 
	`scuŒ_fﬁlow
(
dev
, 
ôem
);

356 i‡(
d±r
 =
NULL
)

357 
out
;

358 i‡(!
d±r
->
d©a
) {

359 
d±r
->
d©a
 = 
	`kmÆloc
(
q£t
 * (*), 
GFP_KERNEL
);

360 i‡(!
d±r
->
d©a
)

361 
out
;

362 
	`mem£t
(
d±r
->
d©a
, 0, 
q£t
 * (*));

364 i‡(!
d±r
->
d©a
[
s_pos
]) {

365 
d±r
->
d©a
[
s_pos
] = 
	`kmÆloc
(
qu™tum
, 
GFP_KERNEL
);

366 i‡(!
d±r
->
d©a
[
s_pos
])

367 
out
;

370 i‡(
cou¡
 > 
qu™tum
 - 
q_pos
)

371 
cou¡
 = 
qu™tum
 - 
q_pos
;

373 i‡(
	`c›y_‰om_u£r
(
d±r
->
d©a
[
s_pos
]+
q_pos
, 
buf
, 
cou¡
)) {

374 
ªtvÆ
 = -
EFAULT
;

375 
out
;

377 *
f_pos
 +
cou¡
;

378 
ªtvÆ
 = 
cou¡
;

381 i‡(
dev
->
size
 < *
f_pos
)

382 
dev
->
size
 = *
f_pos
;

384 
out
:

385 
	`up
(&
dev
->
£m
);

386  
ªtvÆ
;

387 
	}
}

393 
	$scuŒ_io˘l
(
öode
 *öode, 
fûe
 *
fûp
,

394 
cmd
, 
¨g
)

397 
îr
 = 0, 
tmp
;

398 
ªtvÆ
 = 0;

404 i‡(
	`_IOC_TYPE
(
cmd
Ë!
SCULL_IOC_MAGIC
Ë -
ENOTTY
;

405 i‡(
	`_IOC_NR
(
cmd
Ë> 
SCULL_IOC_MAXNR
Ë -
ENOTTY
;

413 i‡(
	`_IOC_DIR
(
cmd
Ë& 
_IOC_READ
)

414 
îr
 = !
	`ac˚ss_ok
(
VERIFY_WRITE
, (
__u£r
 *)
¨g
, 
	`_IOC_SIZE
(
cmd
));

415 i‡(
	`_IOC_DIR
(
cmd
Ë& 
_IOC_WRITE
)

416 
îr
 = !
	`ac˚ss_ok
(
VERIFY_READ
, (
__u£r
 *)
¨g
, 
	`_IOC_SIZE
(
cmd
));

417 i‡(
îr
Ë -
EFAULT
;

419 
cmd
) {

421 
SCULL_IOCRESET
:

422 
scuŒ_qu™tum
 = 
SCULL_QUANTUM
;

423 
scuŒ_q£t
 = 
SCULL_QSET
;

426 
SCULL_IOCSQUANTUM
:

427 i‡(! 
	`ˇ∑bÀ
 (
CAP_SYS_ADMIN
))

428  -
EPERM
;

429 
ªtvÆ
 = 
	`__gë_u£r
(
scuŒ_qu™tum
, (
__u£r
 *)
¨g
);

432 
SCULL_IOCTQUANTUM
:

433 i‡(! 
	`ˇ∑bÀ
 (
CAP_SYS_ADMIN
))

434  -
EPERM
;

435 
scuŒ_qu™tum
 = 
¨g
;

438 
SCULL_IOCGQUANTUM
:

439 
ªtvÆ
 = 
	`__put_u£r
(
scuŒ_qu™tum
, (
__u£r
 *)
¨g
);

442 
SCULL_IOCQQUANTUM
:

443  
scuŒ_qu™tum
;

445 
SCULL_IOCXQUANTUM
:

446 i‡(! 
	`ˇ∑bÀ
 (
CAP_SYS_ADMIN
))

447  -
EPERM
;

448 
tmp
 = 
scuŒ_qu™tum
;

449 
ªtvÆ
 = 
	`__gë_u£r
(
scuŒ_qu™tum
, (
__u£r
 *)
¨g
);

450 i‡(
ªtvÆ
 == 0)

451 
ªtvÆ
 = 
	`__put_u£r
(
tmp
, (
__u£r
 *)
¨g
);

454 
SCULL_IOCHQUANTUM
:

455 i‡(! 
	`ˇ∑bÀ
 (
CAP_SYS_ADMIN
))

456  -
EPERM
;

457 
tmp
 = 
scuŒ_qu™tum
;

458 
scuŒ_qu™tum
 = 
¨g
;

459  
tmp
;

461 
SCULL_IOCSQSET
:

462 i‡(! 
	`ˇ∑bÀ
 (
CAP_SYS_ADMIN
))

463  -
EPERM
;

464 
ªtvÆ
 = 
	`__gë_u£r
(
scuŒ_q£t
, (
__u£r
 *)
¨g
);

467 
SCULL_IOCTQSET
:

468 i‡(! 
	`ˇ∑bÀ
 (
CAP_SYS_ADMIN
))

469  -
EPERM
;

470 
scuŒ_q£t
 = 
¨g
;

473 
SCULL_IOCGQSET
:

474 
ªtvÆ
 = 
	`__put_u£r
(
scuŒ_q£t
, (
__u£r
 *)
¨g
);

477 
SCULL_IOCQQSET
:

478  
scuŒ_q£t
;

480 
SCULL_IOCXQSET
:

481 i‡(! 
	`ˇ∑bÀ
 (
CAP_SYS_ADMIN
))

482  -
EPERM
;

483 
tmp
 = 
scuŒ_q£t
;

484 
ªtvÆ
 = 
	`__gë_u£r
(
scuŒ_q£t
, (
__u£r
 *)
¨g
);

485 i‡(
ªtvÆ
 == 0)

486 
ªtvÆ
 = 
	`put_u£r
(
tmp
, (
__u£r
 *)
¨g
);

489 
SCULL_IOCHQSET
:

490 i‡(! 
	`ˇ∑bÀ
 (
CAP_SYS_ADMIN
))

491  -
EPERM
;

492 
tmp
 = 
scuŒ_q£t
;

493 
scuŒ_q£t
 = 
¨g
;

494  
tmp
;

502 
SCULL_P_IOCTSIZE
:

503 
scuŒ_p_buf„r
 = 
¨g
;

506 
SCULL_P_IOCQSIZE
:

507  
scuŒ_p_buf„r
;

511  -
ENOTTY
;

513  
ªtvÆ
;

515 
	}
}

523 
loff_t
 
	$scuŒ_Œ£ek
(
fûe
 *
fûp
, 
loff_t
 
off
, 
whí˚
)

525 
scuŒ_dev
 *
dev
 = 
fûp
->
¥iv©e_d©a
;

526 
loff_t
 
√wpos
;

528 
whí˚
) {

530 
√wpos
 = 
off
;

534 
√wpos
 = 
fûp
->
f_pos
 + 
off
;

538 
√wpos
 = 
dev
->
size
 + 
off
;

542  -
EINVAL
;

544 i‡(
√wpos
 < 0Ë -
EINVAL
;

545 
fûp
->
f_pos
 = 
√wpos
;

546  
√wpos
;

547 
	}
}

551 
fûe_›î©i⁄s
 
	gscuŒ_f›s
 = {

552 .
ow√r
 = 
THIS_MODULE
,

553 .
	gŒ£ek
 = 
scuŒ_Œ£ek
,

554 .
	gªad
 = 
scuŒ_ªad
,

555 .
	gwrôe
 = 
scuŒ_wrôe
,

556 .
	gio˘l
 = 
scuŒ_io˘l
,

557 .
	g›í
 = 
scuŒ_›í
,

558 .
	gªÀa£
 = 
scuŒ_ªÀa£
,

570 
	$scuŒ_˛ónup_moduÀ
()

572 
i
;

573 
dev_t
 
devno
 = 
	`MKDEV
(
scuŒ_maj‹
, 
scuŒ_mö‹
);

576 i‡(
scuŒ_devi˚s
) {

577 
i
 = 0; i < 
scuŒ_ƒ_devs
; i++) {

578 
	`scuŒ_åim
(
scuŒ_devi˚s
 + 
i
);

579 
	`cdev_dñ
(&
scuŒ_devi˚s
[
i
].
cdev
);

581 
	`k‰ì
(
scuŒ_devi˚s
);

584 #ifde‡
SCULL_DEBUG


585 
	`scuŒ_ªmove_¥oc
();

589 
	`uƒegi°î_chrdev_ªgi⁄
(
devno
, 
scuŒ_ƒ_devs
);

592 
	`scuŒ_p_˛ónup
();

593 
	`scuŒ_ac˚ss_˛ónup
();

595 
	}
}

601 
	$scuŒ_£tup_cdev
(
scuŒ_dev
 *
dev
, 
ödex
)

603 
îr
, 
devno
 = 
	`MKDEV
(
scuŒ_maj‹
, 
scuŒ_mö‹
 + 
ödex
);

605 
	`cdev_öô
(&
dev
->
cdev
, &
scuŒ_f›s
);

606 
dev
->
cdev
.
ow√r
 = 
THIS_MODULE
;

607 
dev
->
cdev
.
›s
 = &
scuŒ_f›s
;

608 
îr
 = 
	`cdev_add
 (&
dev
->
cdev
, 
devno
, 1);

610 i‡(
îr
)

611 
	`¥ötk
(
KERN_NOTICE
 "Eº‹ %dáddög scuŒ%d", 
îr
, 
ödex
);

612 
	}
}

615 
	$scuŒ_öô_moduÀ
()

617 
ªsu…
, 
i
;

618 
dev_t
 
dev
 = 0;

624 i‡(
scuŒ_maj‹
) {

625 
dev
 = 
	`MKDEV
(
scuŒ_maj‹
, 
scuŒ_mö‹
);

626 
ªsu…
 = 
	`ªgi°î_chrdev_ªgi⁄
(
dev
, 
scuŒ_ƒ_devs
, "scull");

628 
ªsu…
 = 
	`Æloc_chrdev_ªgi⁄
(&
dev
, 
scuŒ_mö‹
, 
scuŒ_ƒ_devs
,

630 
scuŒ_maj‹
 = 
	`MAJOR
(
dev
);

632 i‡(
ªsu…
 < 0) {

633 
	`¥ötk
(
KERN_WARNING
 "scuŒ: c™'àgë maj‹ %d\n", 
scuŒ_maj‹
);

634  
ªsu…
;

641 
scuŒ_devi˚s
 = 
	`kmÆloc
(
scuŒ_ƒ_devs
 * (
scuŒ_dev
), 
GFP_KERNEL
);

642 i‡(!
scuŒ_devi˚s
) {

643 
ªsu…
 = -
ENOMEM
;

644 
Áû
;

646 
	`mem£t
(
scuŒ_devi˚s
, 0, 
scuŒ_ƒ_devs
 * (
scuŒ_dev
));

649 
i
 = 0; i < 
scuŒ_ƒ_devs
; i++) {

650 
scuŒ_devi˚s
[
i
].
qu™tum
 = 
scuŒ_qu™tum
;

651 
scuŒ_devi˚s
[
i
].
q£t
 = 
scuŒ_q£t
;

652 
	`öô_MUTEX
(&
scuŒ_devi˚s
[
i
].
£m
);

653 
	`scuŒ_£tup_cdev
(&
scuŒ_devi˚s
[
i
], i);

657 
dev
 = 
	`MKDEV
(
scuŒ_maj‹
, 
scuŒ_mö‹
 + 
scuŒ_ƒ_devs
);

658 
dev
 +
	`scuŒ_p_öô
(dev);

659 
dev
 +
	`scuŒ_ac˚ss_öô
(dev);

661 #ifde‡
SCULL_DEBUG


662 
	`scuŒ_¸óã_¥oc
();

667 
Áû
:

668 
	`scuŒ_˛ónup_moduÀ
();

669  
ªsu…
;

670 
	}
}

672 
moduÀ_öô
(
scuŒ_öô_moduÀ
);

673 
moduÀ_exô
(
scuŒ_˛ónup_moduÀ
);

	@pipe.c

17 
	~<löux/moduÀ.h
>

18 
	~<löux/moduÀ∑øm.h
>

20 
	~<löux/kî√l.h
>

21 
	~<löux/¶ab.h
>

22 
	~<löux/fs.h
>

23 
	~<löux/¥oc_fs.h
>

24 
	~<löux/î∫o.h
>

25 
	~<löux/ty≥s.h
>

26 
	~<löux/f˙é.h
>

27 
	~<löux/pﬁl.h
>

28 
	~<löux/cdev.h
>

29 
	~<asm/uac˚ss.h
>

31 
	~"scuŒ.h
"

33 
	sscuŒ_pùe
 {

34 
waô_queue_hód_t
 
	möq
, 
	moutq
;

35 *
	mbuf„r
, *
	míd
;

36 
	mbuf„rsize
;

37 *
	mΩ
, *
	mwp
;

38 
	mƒódîs
, 
	mnwrôîs
;

39 
Ásync_°ru˘
 *
	masync_queue
;

40 
£m≠h‹e
 
	m£m
;

41 
cdev
 
	mcdev
;

45 
	gscuŒ_p_ƒ_devs
 = 
SCULL_P_NR_DEVS
;

46 
	gscuŒ_p_buf„r
 = 
SCULL_P_BUFFER
;

47 
dev_t
 
	gscuŒ_p_devno
;

49 
moduÀ_∑øm
(
scuŒ_p_ƒ_devs
, , 0);

50 
moduÀ_∑øm
(
scuŒ_p_buf„r
, , 0);

52 
scuŒ_pùe
 *
	gscuŒ_p_devi˚s
;

54 
scuŒ_p_Ásync
(
fd
, 
fûe
 *
fûp
, 
mode
);

55 
•a˚‰ì
(
scuŒ_pùe
 *
dev
);

61 
	$scuŒ_p_›í
(
öode
 *öode, 
fûe
 *
fûp
)

63 
scuŒ_pùe
 *
dev
;

65 
dev
 = 
	`c⁄èöî_of
(
öode
->
i_cdev
, 
scuŒ_pùe
, 
cdev
);

66 
fûp
->
¥iv©e_d©a
 = 
dev
;

68 i‡(
	`down_öãºu±ibÀ
(&
dev
->
£m
))

69  -
ERESTARTSYS
;

70 i‡(!
dev
->
buf„r
) {

72 
dev
->
buf„r
 = 
	`kmÆloc
(
scuŒ_p_buf„r
, 
GFP_KERNEL
);

73 i‡(!
dev
->
buf„r
) {

74 
	`up
(&
dev
->
£m
);

75  -
ENOMEM
;

78 
dev
->
buf„rsize
 = 
scuŒ_p_buf„r
;

79 
dev
->
íd
 = dev->
buf„r
 + dev->
buf„rsize
;

80 
dev
->
Ω
 = dev->
wp
 = dev->
buf„r
;

83 i‡(
fûp
->
f_mode
 & 
FMODE_READ
)

84 
dev
->
ƒódîs
++;

85 i‡(
fûp
->
f_mode
 & 
FMODE_WRITE
)

86 
dev
->
nwrôîs
++;

87 
	`up
(&
dev
->
£m
);

89  
	`n⁄£ekabÀ_›í
(
öode
, 
fûp
);

90 
	}
}

94 
	$scuŒ_p_ªÀa£
(
öode
 *öode, 
fûe
 *
fûp
)

96 
scuŒ_pùe
 *
dev
 = 
fûp
->
¥iv©e_d©a
;

99 
	`scuŒ_p_Ásync
(-1, 
fûp
, 0);

100 
	`down
(&
dev
->
£m
);

101 i‡(
fûp
->
f_mode
 & 
FMODE_READ
)

102 
dev
->
ƒódîs
--;

103 i‡(
fûp
->
f_mode
 & 
FMODE_WRITE
)

104 
dev
->
nwrôîs
--;

105 i‡(
dev
->
ƒódîs
 + dev->
nwrôîs
 == 0) {

106 
	`k‰ì
(
dev
->
buf„r
);

107 
dev
->
buf„r
 = 
NULL
;

109 
	`up
(&
dev
->
£m
);

111 
	}
}

118 
ssize_t
 
	$scuŒ_p_ªad
 (
fûe
 *
fûp
, 
__u£r
 *
buf
, 
size_t
 
cou¡
,

119 
loff_t
 *
f_pos
)

121 
scuŒ_pùe
 *
dev
 = 
fûp
->
¥iv©e_d©a
;

123 i‡(
	`down_öãºu±ibÀ
(&
dev
->
£m
))

124  -
ERESTARTSYS
;

126 
dev
->
Ω
 =dev->
wp
) {

127 
	`up
(&
dev
->
£m
);

128 i‡(
fûp
->
f_Êags
 & 
O_NONBLOCK
)

129  -
EAGAIN
;

130 
	`PDEBUG
("\"%s\"Ñódög: goögÅÿ¶ìp\n", 
cuºít
->
comm
);

131 i‡(
	`waô_evít_öãºu±ibÀ
(
dev
->
öq
, (dev->
Ω
 !dev->
wp
)))

132  -
ERESTARTSYS
;

134 i‡(
	`down_öãºu±ibÀ
(&
dev
->
£m
))

135  -
ERESTARTSYS
;

138 i‡(
dev
->
wp
 > dev->
Ω
)

139 
cou¡
 = 
	`mö
(cou¡, (
size_t
)(
dev
->
wp
 - dev->
Ω
));

141 
cou¡
 = 
	`mö
(cou¡, (
size_t
)(
dev
->
íd
 - dev->
Ω
));

142 i‡(
	`c›y_to_u£r
(
buf
, 
dev
->
Ω
, 
cou¡
)) {

143 
	`up
 (&
dev
->
£m
);

144  -
EFAULT
;

146 
dev
->
Ω
 +
cou¡
;

147 i‡(
dev
->
Ω
 =dev->
íd
)

148 
dev
->
Ω
 = dev->
buf„r
;

149 
	`up
 (&
dev
->
£m
);

152 
	`wake_up_öãºu±ibÀ
(&
dev
->
outq
);

153 
	`PDEBUG
("\"%s\" didÑód %lòbyãs\n",
cuºít
->
comm
, ()
cou¡
);

154  
cou¡
;

155 
	}
}

159 
	$scuŒ_gëwrôe•a˚
(
scuŒ_pùe
 *
dev
, 
fûe
 *
fûp
)

161 
	`•a˚‰ì
(
dev
) == 0) {

162 
	`DEFINE_WAIT
(
waô
);

164 
	`up
(&
dev
->
£m
);

165 i‡(
fûp
->
f_Êags
 & 
O_NONBLOCK
)

166  -
EAGAIN
;

167 
	`PDEBUG
("\"%s\" wrôög: goögÅÿ¶ìp\n",
cuºít
->
comm
);

168 
	`¥ï¨e_to_waô
(&
dev
->
outq
, &
waô
, 
TASK_INTERRUPTIBLE
);

169 i‡(
	`•a˚‰ì
(
dev
) == 0)

170 
	`scheduÀ
();

171 
	`föish_waô
(&
dev
->
outq
, &
waô
);

172 i‡(
	`sig«l_≥ndög
(
cuºít
))

173  -
ERESTARTSYS
;

174 i‡(
	`down_öãºu±ibÀ
(&
dev
->
£m
))

175  -
ERESTARTSYS
;

178 
	}
}

181 
	$•a˚‰ì
(
scuŒ_pùe
 *
dev
)

183 i‡(
dev
->
Ω
 =dev->
wp
)

184  
dev
->
buf„rsize
 - 1;

185  ((
dev
->
Ω
 + dev->
buf„rsize
 - dev->
wp
) % dev->buffersize) - 1;

186 
	}
}

188 
ssize_t
 
	$scuŒ_p_wrôe
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
, 
size_t
 
cou¡
,

189 
loff_t
 *
f_pos
)

191 
scuŒ_pùe
 *
dev
 = 
fûp
->
¥iv©e_d©a
;

192 
ªsu…
;

194 i‡(
	`down_öãºu±ibÀ
(&
dev
->
£m
))

195  -
ERESTARTSYS
;

198 
ªsu…
 = 
	`scuŒ_gëwrôe•a˚
(
dev
, 
fûp
);

199 i‡(
ªsu…
)

200  
ªsu…
;

203 
cou¡
 = 
	`mö
(cou¡, (
size_t
)
	`•a˚‰ì
(
dev
));

204 i‡(
dev
->
wp
 >dev->
Ω
)

205 
cou¡
 = 
	`mö
(cou¡, (
size_t
)(
dev
->
íd
 - dev->
wp
));

207 
cou¡
 = 
	`mö
(cou¡, (
size_t
)(
dev
->
Ω
 - dev->
wp
 - 1));

208 
	`PDEBUG
("GoögÅÿac˚± %lòbyã†tÿ%∞‰om %p\n", ()
cou¡
, 
dev
->
wp
, 
buf
);

209 i‡(
	`c›y_‰om_u£r
(
dev
->
wp
, 
buf
, 
cou¡
)) {

210 
	`up
 (&
dev
->
£m
);

211  -
EFAULT
;

213 
dev
->
wp
 +
cou¡
;

214 i‡(
dev
->
wp
 =dev->
íd
)

215 
dev
->
wp
 = dev->
buf„r
;

216 
	`up
(&
dev
->
£m
);

219 
	`wake_up_öãºu±ibÀ
(&
dev
->
öq
);

222 i‡(
dev
->
async_queue
)

223 
	`kûl_Ásync
(&
dev
->
async_queue
, 
SIGIO
, 
POLL_IN
);

224 
	`PDEBUG
("\"%s\" did wrôê%lòbyãs\n",
cuºít
->
comm
, ()
cou¡
);

225  
cou¡
;

226 
	}
}

228 
	$scuŒ_p_pﬁl
(
fûe
 *
fûp
, 
pﬁl_èbÀ
 *
waô
)

230 
scuŒ_pùe
 *
dev
 = 
fûp
->
¥iv©e_d©a
;

231 
mask
 = 0;

238 
	`down
(&
dev
->
£m
);

239 
	`pﬁl_waô
(
fûp
, &
dev
->
öq
, 
waô
);

240 
	`pﬁl_waô
(
fûp
, &
dev
->
outq
, 
waô
);

241 i‡(
dev
->
Ω
 !dev->
wp
)

242 
mask
 |
POLLIN
 | 
POLLRDNORM
;

243 i‡(
	`•a˚‰ì
(
dev
))

244 
mask
 |
POLLOUT
 | 
POLLWRNORM
;

245 
	`up
(&
dev
->
£m
);

246  
mask
;

247 
	}
}

253 
	$scuŒ_p_Ásync
(
fd
, 
fûe
 *
fûp
, 
mode
)

255 
scuŒ_pùe
 *
dev
 = 
fûp
->
¥iv©e_d©a
;

257  
	`Ásync_hñ≥r
(
fd
, 
fûp
, 
mode
, &
dev
->
async_queue
);

258 
	}
}

263 #ifde‡
SCULL_DEBUG


264 
	$scuŒp_¥oc_off£t
(*
buf
, **
°¨t
, 
off_t
 *
off£t
, *
Àn
)

266 i‡(*
off£t
 == 0)

268 i‡(*
off£t
 >*
Àn
) {

269 *
off£t
 -*
Àn
;

270 *
Àn
 = 0;

273 *
°¨t
 = 
buf
 + *
off£t
;

274 *
off£t
 = 0;

276 
	}
}

279 
	$scuŒ_ªad_p_mem
(*
buf
, **
°¨t
, 
off_t
 
off£t
, 
cou¡
,

280 *
eof
, *
d©a
)

282 
i
, 
Àn
;

283 
scuŒ_pùe
 *
p
;

285 
	#LIMIT
 (
PAGE_SIZE
-200Ë

	)

286 *
°¨t
 = 
buf
;

287 
Àn
 = 
	`•rötf
(
buf
, "DeÁu… buf„rsizêi†%i\n", 
scuŒ_p_buf„r
);

288 
i
 = 0; i<
scuŒ_p_ƒ_devs
 && 
Àn
 <
LIMIT
; i++) {

289 
p
 = &
scuŒ_p_devi˚s
[
i
];

290 i‡(
	`down_öãºu±ibÀ
(&
p
->
£m
))

291  -
ERESTARTSYS
;

292 
Àn
 +
	`•rötf
(
buf
+Àn, "\nDevi˚ %i: %p\n", 
i
, 
p
);

294 
Àn
 +
	`•rötf
(
buf
+Àn, " Buf„r: %∞tÿ%∞(%òbyãs)\n", 
p
->
buf„r
,Ö->
íd
,Ö->
buf„rsize
);

295 
Àn
 +
	`•rötf
(
buf
+Àn, "Ñ∞%∞ w∞%p\n", 
p
->
Ω
,Ö->
wp
);

296 
Àn
 +
	`•rötf
(
buf
+Àn, "Ñódî†%ò wrôî†%i\n", 
p
->
ƒódîs
,Ö->
nwrôîs
);

297 
	`up
(&
p
->
£m
);

298 
	`scuŒp_¥oc_off£t
(
buf
, 
°¨t
, &
off£t
, &
Àn
);

300 *
eof
 = (
Àn
 <
LIMIT
);

301  
Àn
;

302 
	}
}

313 
fûe_›î©i⁄s
 
	gscuŒ_pùe_f›s
 = {

314 .
ow√r
 = 
THIS_MODULE
,

315 .
	gŒ£ek
 = 
no_Œ£ek
,

316 .
	gªad
 = 
scuŒ_p_ªad
,

317 .
	gwrôe
 = 
scuŒ_p_wrôe
,

318 .
	gpﬁl
 = 
scuŒ_p_pﬁl
,

319 .
	gio˘l
 = 
scuŒ_io˘l
,

320 .
	g›í
 = 
scuŒ_p_›í
,

321 .
	gªÀa£
 = 
scuŒ_p_ªÀa£
,

322 .
	gÁsync
 = 
scuŒ_p_Ásync
,

329 
	$scuŒ_p_£tup_cdev
(
scuŒ_pùe
 *
dev
, 
ödex
)

331 
îr
, 
devno
 = 
scuŒ_p_devno
 + 
ödex
;

333 
	`cdev_öô
(&
dev
->
cdev
, &
scuŒ_pùe_f›s
);

334 
dev
->
cdev
.
ow√r
 = 
THIS_MODULE
;

335 
îr
 = 
	`cdev_add
 (&
dev
->
cdev
, 
devno
, 1);

337 i‡(
îr
)

338 
	`¥ötk
(
KERN_NOTICE
 "Eº‹ %dáddög scuŒpùe%d", 
îr
, 
ödex
);

339 
	}
}

346 
	$scuŒ_p_öô
(
dev_t
 
fú°dev
)

348 
i
, 
ªsu…
;

350 
ªsu…
 = 
	`ªgi°î_chrdev_ªgi⁄
(
fú°dev
, 
scuŒ_p_ƒ_devs
, "scullp");

351 i‡(
ªsu…
 < 0) {

352 
	`¥ötk
(
KERN_NOTICE
 "U«bÀÅÿgë scuŒ∞ªgi⁄,Éº‹ %d\n", 
ªsu…
);

355 
scuŒ_p_devno
 = 
fú°dev
;

356 
scuŒ_p_devi˚s
 = 
	`kmÆloc
(
scuŒ_p_ƒ_devs
 * (
scuŒ_pùe
), 
GFP_KERNEL
);

357 i‡(
scuŒ_p_devi˚s
 =
NULL
) {

358 
	`uƒegi°î_chrdev_ªgi⁄
(
fú°dev
, 
scuŒ_p_ƒ_devs
);

361 
	`mem£t
(
scuŒ_p_devi˚s
, 0, 
scuŒ_p_ƒ_devs
 * (
scuŒ_pùe
));

362 
i
 = 0; i < 
scuŒ_p_ƒ_devs
; i++) {

363 
	`öô_waôqueue_hód
(&(
scuŒ_p_devi˚s
[
i
].
öq
));

364 
	`öô_waôqueue_hód
(&(
scuŒ_p_devi˚s
[
i
].
outq
));

365 
	`öô_MUTEX
(&
scuŒ_p_devi˚s
[
i
].
£m
);

366 
	`scuŒ_p_£tup_cdev
(
scuŒ_p_devi˚s
 + 
i
, i);

368 #ifde‡
SCULL_DEBUG


369 
	`¸óã_¥oc_ªad_íåy
("scuŒpùe", 0, 
NULL
, 
scuŒ_ªad_p_mem
, NULL);

371  
scuŒ_p_ƒ_devs
;

372 
	}
}

378 
	$scuŒ_p_˛ónup
()

380 
i
;

382 #ifde‡
SCULL_DEBUG


383 
	`ªmove_¥oc_íåy
("scuŒpùe", 
NULL
);

386 i‡(!
scuŒ_p_devi˚s
)

389 
i
 = 0; i < 
scuŒ_p_ƒ_devs
; i++) {

390 
	`cdev_dñ
(&
scuŒ_p_devi˚s
[
i
].
cdev
);

391 
	`k‰ì
(
scuŒ_p_devi˚s
[
i
].
buf„r
);

393 
	`k‰ì
(
scuŒ_p_devi˚s
);

394 
	`uƒegi°î_chrdev_ªgi⁄
(
scuŒ_p_devno
, 
scuŒ_p_ƒ_devs
);

395 
scuŒ_p_devi˚s
 = 
NULL
;

396 
	}
}

	@scull.h

18 #i‚de‡
_SCULL_H_


19 
	#_SCULL_H_


	)

21 
	~<löux/io˘l.h
>

27 #unde‡
PDEBUG


28 #ifde‡
SCULL_DEBUG


29 #ifde‡
__KERNEL__


31 
	#PDEBUG
(
fmt
, 
¨gs
...Ë
	`¥ötk
–
KERN_DEBUG
 "scuŒ: " fmt, ##árgs)

	)

34 
	#PDEBUG
(
fmt
, 
¨gs
...Ë
	`Ârötf
(
°dîr
, fmt, ##árgs)

	)

37 
	#PDEBUG
(
fmt
, 
¨gs
...Ë

	)

40 #unde‡
PDEBUGG


41 
	#PDEBUGG
(
fmt
, 
¨gs
...Ë

	)

43 #i‚de‡
SCULL_MAJOR


44 
	#SCULL_MAJOR
 0

	)

47 #i‚de‡
SCULL_NR_DEVS


48 
	#SCULL_NR_DEVS
 4

	)

51 #i‚de‡
SCULL_P_NR_DEVS


52 
	#SCULL_P_NR_DEVS
 4

	)

64 #i‚de‡
SCULL_QUANTUM


65 
	#SCULL_QUANTUM
 4000

	)

68 #i‚de‡
SCULL_QSET


69 
	#SCULL_QSET
 1000

	)

75 #i‚de‡
SCULL_P_BUFFER


76 
	#SCULL_P_BUFFER
 4000

	)

82 
	sscuŒ_q£t
 {

83 **
	md©a
;

84 
scuŒ_q£t
 *
	m√xt
;

87 
	sscuŒ_dev
 {

88 
scuŒ_q£t
 *
	md©a
;

89 
	mqu™tum
;

90 
	mq£t
;

91 
	msize
;

92 
	mac˚ss_key
;

93 
£m≠h‹e
 
	m£m
;

94 
cdev
 
	mcdev
;

100 
	#TYPE
(
mö‹
Ë(((mö‹Ë>> 4Ë& 0xfË

	)

101 
	#NUM
(
mö‹
Ë((mö‹Ë& 0xfË

	)

107 
scuŒ_maj‹
;

108 
scuŒ_ƒ_devs
;

109 
scuŒ_qu™tum
;

110 
scuŒ_q£t
;

112 
scuŒ_p_buf„r
;

119 
scuŒ_p_öô
(
dev_t
 
dev
);

120 
scuŒ_p_˛ónup
();

121 
scuŒ_ac˚ss_öô
(
dev_t
 
dev
);

122 
scuŒ_ac˚ss_˛ónup
();

124 
scuŒ_åim
(
scuŒ_dev
 *
dev
);

126 
ssize_t
 
scuŒ_ªad
(
fûe
 *
fûp
, 
__u£r
 *
buf
, 
size_t
 
cou¡
,

127 
loff_t
 *
f_pos
);

128 
ssize_t
 
scuŒ_wrôe
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
, 
size_t
 
cou¡
,

129 
loff_t
 *
f_pos
);

130 
loff_t
 
scuŒ_Œ£ek
(
fûe
 *
fûp
,Üoff_à
off
, 
whí˚
);

131 
scuŒ_io˘l
(
öode
 *öode, 
fûe
 *
fûp
,

132 
cmd
, 
¨g
);

140 
	#SCULL_IOC_MAGIC
 'k'

	)

143 
	#SCULL_IOCRESET
 
	`_IO
(
SCULL_IOC_MAGIC
, 0)

	)

153 
	#SCULL_IOCSQUANTUM
 
	`_IOW
(
SCULL_IOC_MAGIC
, 1, )

	)

154 
	#SCULL_IOCSQSET
 
	`_IOW
(
SCULL_IOC_MAGIC
, 2, )

	)

155 
	#SCULL_IOCTQUANTUM
 
	`_IO
(
SCULL_IOC_MAGIC
, 3)

	)

156 
	#SCULL_IOCTQSET
 
	`_IO
(
SCULL_IOC_MAGIC
, 4)

	)

157 
	#SCULL_IOCGQUANTUM
 
	`_IOR
(
SCULL_IOC_MAGIC
, 5, )

	)

158 
	#SCULL_IOCGQSET
 
	`_IOR
(
SCULL_IOC_MAGIC
, 6, )

	)

159 
	#SCULL_IOCQQUANTUM
 
	`_IO
(
SCULL_IOC_MAGIC
, 7)

	)

160 
	#SCULL_IOCQQSET
 
	`_IO
(
SCULL_IOC_MAGIC
, 8)

	)

161 
	#SCULL_IOCXQUANTUM
 
	`_IOWR
(
SCULL_IOC_MAGIC
, 9, )

	)

162 
	#SCULL_IOCXQSET
 
	`_IOWR
(
SCULL_IOC_MAGIC
,10, )

	)

163 
	#SCULL_IOCHQUANTUM
 
	`_IO
(
SCULL_IOC_MAGIC
, 11)

	)

164 
	#SCULL_IOCHQSET
 
	`_IO
(
SCULL_IOC_MAGIC
, 12)

	)

171 
	#SCULL_P_IOCTSIZE
 
	`_IO
(
SCULL_IOC_MAGIC
, 13)

	)

172 
	#SCULL_P_IOCQSIZE
 
	`_IO
(
SCULL_IOC_MAGIC
, 14)

	)

175 
	#SCULL_IOC_MAXNR
 14

	)

	@
1
.
0
4
31
access.c
main.c
pipe.c
scull.h
