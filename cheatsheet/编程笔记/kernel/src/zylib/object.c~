/*
 * =====================================================================================
 *
 *       Filename:  object.c
 *
 *    Description:  
 *
 *        Version:  1.0
 *        Created:  16.03.10
 *       Revision:  
 *       Compiler:  GCC 4.4.3
 *
 *         Author:  Yang Zhang, imyeyeslove@gmail.com
 *        Company:  
 *
 * =====================================================================================
 */

/* 
 * ===  FUNCTION  ======================================================================
 *         Name:  class_of
 *  Description:  class of a given object
 *
 *  		  the only thing that one object always have is a pointer to it's class
 * =====================================================================================
 */
void * class_of(void * _obj)
{
	const struct class * cla = _obj;                /* upcasting */
	return cla->class;
}

/* 
 * ===  FUNCTION  ======================================================================
 *         Name:  super_of
 *  Description:  a class' super class
 * =====================================================================================
 */
void * super_of(void * _cla) {
	const struct class * cla = _cla;
	return cla->super;
}

/* 
 * ===  FUNCTION  ======================================================================
 *         Name:  size_of
 *  Description:  a object may not have it's size element, so can't "->size" directly
 *  		  but it was generated by it's class-desc, so it has the record of
 *  		  the object
 * =====================================================================================
 */
size_t * size_of(void * _self) {
	const struct class * cla = class_of(_self);
	return cla->size;
}

/* 
 * ===  FUNCTION  ======================================================================
 *         Name:  name_of
 *  Description:  the class' name
 * =====================================================================================
 */
const char * name_of(void * _cla) {
	const struct class * cla = _cla;
	return cla->name;
}


static struct class obj[2] = {
	{ obj[0], obj[1], "Object", sizeof(struct class), obj_ctor, obj_dtor },
	{ obj[0], obj[1], "Class", sizeof(struct class), cla_ctor, cla_dtor }
};

const void * object = obj;
const void * class = obj + 1;

void * new(void * _cla, ...) {
	va_list arg;
	struct class * cla = _cla;
	struct object * obj;

	object = calloc(1, cla->size);
	object->class = cla;                            /* just 1 component */

	va_start(arg, _cla);
	object = ctor(object, &arg);
	va_end(ap);

	return object;
}

void * ctor(void * _self) {
	struct class * cla = _self;
	return cla->ctor(_self);
}
