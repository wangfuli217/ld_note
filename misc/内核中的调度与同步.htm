<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=gb2312">
<meta name=ProgId content=FrontPage.Editor.Document>
<meta name=Generator content="Microsoft FrontPage 4.0">
<meta name=Originator content="Microsoft Word 10">
<link rel=File-List href="syn.files/filelist.xml">
<link rel=Edit-Time-Data href="syn.files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title>内核中的调度与同步</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>test2</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>kh</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>204</o:TotalTime>
  <o:Created>2004-09-24T13:27:00Z</o:Created>
  <o:LastSaved>2004-09-24T13:27:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>1342</o:Words>
  <o:Characters>7655</o:Characters>
  <o:Company>csip</o:Company>
  <o:Lines>63</o:Lines>
  <o:Paragraphs>17</o:Paragraphs>
  <o:CharactersWithSpaces>8980</o:CharactersWithSpaces>
  <o:Version>10.2625</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:DontDisplayPageBoundaries/>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:PunctuationKerning/>
  <w:DrawingGridVerticalSpacing>7.8 磅</w:DrawingGridVerticalSpacing>
  <w:DisplayHorizontalDrawingGridEvery>0</w:DisplayHorizontalDrawingGridEvery>
  <w:DisplayVerticalDrawingGridEvery>2</w:DisplayVerticalDrawingGridEvery>
  <w:Compatibility>
   <w:SpaceForUL/>
   <w:BalanceSingleByteDoubleByteWidth/>
   <w:DoNotLeaveBackslashAlone/>
   <w:ULTrailSpace/>
   <w:DoNotExpandShiftReturn/>
   <w:AdjustLineHeightInTable/>
   <w:BreakWrappedTables/>
   <w:SnapToGridInCell/>
   <w:WrapTextWithPunct/>
   <w:UseAsianBreakRules/>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;
	mso-font-charset:2;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:黑体;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimHei;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:1 135135232 16 0 262144 0;}
@font-face
	{font-family:东文宋体;
	mso-font-alt:"Times New Roman";
	mso-font-charset:0;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 0 0 0 0 0;}
@font-face
	{font-family:"\@宋体";
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:"\@黑体";
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:1 135135232 16 0 262144 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	mso-pagination:none;
	font-size:10.5pt;
	mso-bidi-font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:宋体;
	mso-font-kerning:1.0pt;}
h1
	{mso-style-next:正文;
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:240%;
	mso-pagination:lines-together;
	page-break-after:avoid;
	mso-outline-level:1;
	font-size:22.0pt;
	font-family:"Times New Roman";
	mso-font-kerning:22.0pt;}
h2
	{mso-style-link:" Char";
	mso-style-next:正文;
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:173%;
	mso-pagination:lines-together;
	page-break-after:avoid;
	mso-outline-level:2;
	font-size:16.0pt;
	font-family:Arial;
	mso-fareast-font-family:黑体;
	mso-bidi-font-family:"Times New Roman";
	mso-font-kerning:1.0pt;}
h3
	{mso-style-next:正文;
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:173%;
	mso-pagination:lines-together;
	page-break-after:avoid;
	mso-outline-level:3;
	font-size:16.0pt;
	font-family:"Times New Roman";
	mso-font-kerning:1.0pt;}
h4
	{mso-style-next:正文;
	margin-top:14.0pt;
	margin-right:0cm;
	margin-bottom:14.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:156%;
	mso-pagination:lines-together;
	page-break-after:avoid;
	mso-outline-level:4;
	font-size:14.0pt;
	font-family:Arial;
	mso-fareast-font-family:黑体;
	mso-bidi-font-family:"Times New Roman";
	mso-font-kerning:1.0pt;}
h5
	{mso-style-next:正文;
	margin-top:14.0pt;
	margin-right:0cm;
	margin-bottom:14.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:156%;
	mso-pagination:lines-together;
	page-break-after:avoid;
	mso-outline-level:5;
	font-size:14.0pt;
	font-family:"Times New Roman";
	mso-font-kerning:1.0pt;}
p.MsoBodyTextIndent, li.MsoBodyTextIndent, div.MsoBodyTextIndent
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:21.0pt;
	mso-char-indent-count:2.0;
	mso-pagination:none;
	font-size:10.5pt;
	mso-bidi-font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:宋体;
	mso-font-kerning:1.0pt;}
p.MsoBodyTextIndent2, li.MsoBodyTextIndent2, div.MsoBodyTextIndent2
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:6.0pt;
	margin-left:21.0pt;
	mso-para-margin-top:0cm;
	mso-para-margin-right:0cm;
	mso-para-margin-bottom:6.0pt;
	mso-para-margin-left:2.0gd;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:200%;
	mso-pagination:none;
	font-size:10.5pt;
	mso-bidi-font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:宋体;
	mso-font-kerning:1.0pt;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
p.MsoDocumentMap, li.MsoDocumentMap, div.MsoDocumentMap
	{mso-style-noshow:yes;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	mso-pagination:none;
	background:navy;
	font-size:10.5pt;
	mso-bidi-font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:宋体;
	mso-font-kerning:1.0pt;}
p.MsoPlainText, li.MsoPlainText, div.MsoPlainText
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	mso-pagination:none;
	font-size:10.5pt;
	mso-bidi-font-size:10.0pt;
	font-family:宋体;
	mso-hansi-font-family:"Courier New";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	mso-font-kerning:1.0pt;}
address
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	mso-pagination:none;
	font-size:10.5pt;
	mso-bidi-font-size:12.0pt;
	font-family:"Times New Roman";
	mso-font-kerning:1.0pt;}
span.Char
	{mso-style-name:" Char";
	mso-style-link:"标题 2";
	mso-ansi-font-size:16.0pt;
	mso-bidi-font-size:16.0pt;
	font-family:Arial;
	mso-ascii-font-family:Arial;
	mso-fareast-font-family:黑体;
	mso-hansi-font-family:Arial;
	mso-font-kerning:1.0pt;
	mso-ansi-language:EN-US;
	mso-fareast-language:ZH-CN;
	mso-bidi-language:AR-SA;
	font-weight:bold;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
 /* Page Definitions */
 @page
	{mso-page-border-surround-header:no;
	mso-page-border-surround-footer:no;}
@page Section1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	mso-header-margin:42.55pt;
	mso-footer-margin:49.6pt;
	mso-paper-source:0;
	layout-grid:15.6pt;}
div.Section1
	{page:Section1;}
 /* List Definitions */
 @list l0
	{mso-list-id:1;
	mso-list-type:simple;
	mso-list-template-ids:1;
	mso-list-name:WW8Num1;}
@list l0:level1
	{mso-level-number-format:bullet;
	mso-level-suffix:none;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:0cm;
	text-indent:0cm;
	mso-ascii-font-family:Wingdings;
	mso-hansi-font-family:Wingdings;}
@list l1
	{mso-list-id:124470981;
	mso-list-template-ids:-92765112;}
@list l1:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l1:level2
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l1:level3
	{mso-level-number-format:bullet;
	mso-level-text:\F075;
	mso-level-tab-stop:63.0pt;
	mso-level-number-position:left;
	margin-left:63.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l1:level4
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:84.0pt;
	mso-level-number-position:left;
	margin-left:84.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l1:level5
	{mso-level-number-format:bullet;
	mso-level-text:\F06E;
	mso-level-tab-stop:105.0pt;
	mso-level-number-position:left;
	margin-left:105.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l1:level6
	{mso-level-number-format:bullet;
	mso-level-text:\F075;
	mso-level-tab-stop:126.0pt;
	mso-level-number-position:left;
	margin-left:126.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l1:level7
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:147.0pt;
	mso-level-number-position:left;
	margin-left:147.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l1:level8
	{mso-level-number-format:bullet;
	mso-level-text:\F06E;
	mso-level-tab-stop:168.0pt;
	mso-level-number-position:left;
	margin-left:168.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l1:level9
	{mso-level-number-format:bullet;
	mso-level-text:\F075;
	mso-level-tab-stop:189.0pt;
	mso-level-number-position:left;
	margin-left:189.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l2
	{mso-list-id:414480599;
	mso-list-template-ids:-1428641784;}
@list l2:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l2:level2
	{mso-level-number-format:bullet;
	mso-level-text:\F06E;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l2:level3
	{mso-level-number-format:bullet;
	mso-level-text:\F075;
	mso-level-tab-stop:63.0pt;
	mso-level-number-position:left;
	margin-left:63.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l2:level4
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:84.0pt;
	mso-level-number-position:left;
	margin-left:84.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l2:level5
	{mso-level-number-format:bullet;
	mso-level-text:\F06E;
	mso-level-tab-stop:105.0pt;
	mso-level-number-position:left;
	margin-left:105.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l2:level6
	{mso-level-number-format:bullet;
	mso-level-text:\F075;
	mso-level-tab-stop:126.0pt;
	mso-level-number-position:left;
	margin-left:126.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l2:level7
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:147.0pt;
	mso-level-number-position:left;
	margin-left:147.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l2:level8
	{mso-level-number-format:bullet;
	mso-level-text:\F06E;
	mso-level-tab-stop:168.0pt;
	mso-level-number-position:left;
	margin-left:168.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l2:level9
	{mso-level-number-format:bullet;
	mso-level-text:\F075;
	mso-level-tab-stop:189.0pt;
	mso-level-number-position:left;
	margin-left:189.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l3
	{mso-list-id:502866821;
	mso-list-type:hybrid;
	mso-list-template-ids:-1428641784 -1215257034 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l3:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l3:level2
	{mso-level-number-format:bullet;
	mso-level-text:\F06E;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l4
	{mso-list-id:530610271;
	mso-list-type:hybrid;
	mso-list-template-ids:1340742272 -1215257034 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l4:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l4:level2
	{mso-level-number-format:bullet;
	mso-level-text:\F06E;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l5
	{mso-list-id:569072818;
	mso-list-template-ids:-1428641784;}
@list l5:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l5:level2
	{mso-level-number-format:bullet;
	mso-level-text:\F06E;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l5:level3
	{mso-level-number-format:bullet;
	mso-level-text:\F075;
	mso-level-tab-stop:63.0pt;
	mso-level-number-position:left;
	margin-left:63.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l5:level4
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:84.0pt;
	mso-level-number-position:left;
	margin-left:84.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l5:level5
	{mso-level-number-format:bullet;
	mso-level-text:\F06E;
	mso-level-tab-stop:105.0pt;
	mso-level-number-position:left;
	margin-left:105.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l5:level6
	{mso-level-number-format:bullet;
	mso-level-text:\F075;
	mso-level-tab-stop:126.0pt;
	mso-level-number-position:left;
	margin-left:126.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l5:level7
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:147.0pt;
	mso-level-number-position:left;
	margin-left:147.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l5:level8
	{mso-level-number-format:bullet;
	mso-level-text:\F06E;
	mso-level-tab-stop:168.0pt;
	mso-level-number-position:left;
	margin-left:168.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l5:level9
	{mso-level-number-format:bullet;
	mso-level-text:\F075;
	mso-level-tab-stop:189.0pt;
	mso-level-number-position:left;
	margin-left:189.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l6
	{mso-list-id:697776369;
	mso-list-type:hybrid;
	mso-list-template-ids:1020681514 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l6:level1
	{mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;}
@list l7
	{mso-list-id:897668067;
	mso-list-type:hybrid;
	mso-list-template-ids:170316726 -1215257034 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l7:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l7:level2
	{mso-level-number-format:bullet;
	mso-level-text:\F06E;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l8
	{mso-list-id:1234043859;
	mso-list-type:hybrid;
	mso-list-template-ids:-991243302 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l8:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:21.0pt;
	mso-level-number-position:left;
	margin-left:21.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l9
	{mso-list-id:1427191167;
	mso-list-type:hybrid;
	mso-list-template-ids:-92765112 -1215257034 -1215257034 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l9:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l9:level2
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:普通表格;
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
  <o:regrouptable v:ext="edit">
   <o:entry new="1" old="0"/>
  </o:regrouptable>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=ZH-CN link=blue vlink=purple style='tab-interval:21.0pt;text-justify-trim:
punctuation'>

<div class=Section1 style='layout-grid:15.6pt'>

<h1 align=center style='text-align:center'><span style='font-family:宋体;
mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>内核中的调度与同步</span></h1>

<h2><span style='font-family:黑体;mso-ascii-font-family:Arial'>摘要</span></h2>

<p class=MsoNormal style='text-indent:15.75pt;mso-char-indent-count:1.5'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>本章将为大家介绍内核中存在的各种任务调度机理以及它们之间的逻辑关系（这里将覆盖进程调度、推后执行、中断等概念），在此基础上向大家解释内核中需要同步保护的根本原因和保护方法。最后提供一个内核共享链表同步访问的例子，帮助大家理解内核编程中的同步问题。</span></p>

<h2><span style='font-family:黑体;mso-ascii-font-family:Arial'>内核任务调度与同步关系引言</span></h2>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>对于从事应用程序开发的朋友来说，用户空间的任务调度与同步之间的关系相对简单，无需过多考虑需要同步的原因。这一是因为在用户空间中各个进程都拥有独立的运行空间，进程内部的数据对外不可见，所以各个进程即使并发执行也不会产生对数据访问的竞争。第二是因为用户空间与内核空间独立，所以用户进程不会与<b
style='mso-bidi-font-weight:normal'><i style='mso-bidi-font-style:normal'>内核任务</i></b>交错执行，因此用户进程不存在与内核任务并发的可能。以上两个原因使得用户同步仅仅需要在进程间通讯和多线程编程时需要考虑。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>但是在内核空间中情况要复杂得多，需要考虑同步的原因大大增加了。这是因为内核空间中的共享数据对内核中的所有任务可见，所以当在内核中访问数据时，就必须考虑是否会有其他内核任务并发访问的可能、是否会产生竞争条件、是否需要对数据同步。而内核并发的“罪魁祸首”便是内核中复杂多变的任务调度――这里的任务调度包含所有可能引起内核任务更换的情况。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><i
style='mso-bidi-font-style:normal'><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman";background:#D9D9D9;
mso-shading:white;mso-pattern:gray-15 auto'>并发，竞争和同步的概念，我们假定大家都有所了解，本文不再重申。下面一段描述了上述几个概念之间的大致关系，这种关系在内核中同样适用。</span><span
lang=EN-US style='background:#D9D9D9;mso-shading:white;mso-pattern:gray-15 auto'><o:p></o:p></span></i></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0;
layout-grid-mode:char'><i style='mso-bidi-font-style:normal'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman";background:#D9D9D9;mso-shading:white;mso-pattern:gray-15 auto'>对于多线程程序的开发者来说，往往会利用多线程访问共享数据，避免繁琐的进程间通讯。但是多线程对共享数据的并发访问有可能产生竞争，使得数据处于不一致状态，所以需要一些同步方法来保护共享数据。多线程的并发执行是由于线程被抢占式的调度――一个线程在对共享数据访问期间（还未完成）被调度程序中断，将另一个线程投入运行――如果新被调度的线程也要对这个共享数据进行访问，就将产生竞争。为了避免竞争产生，需要使线程串行地访问共享数据</span><span
style='background:#D9D9D9;mso-shading:white;mso-pattern:gray-15 auto'> </span></i><i
style='mso-bidi-font-style:normal'><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman";background:#D9D9D9;
mso-shading:white;mso-pattern:gray-15 auto'>，也就是说访问需要同步――在一方对数据访问结束后，另一方才能对同一数据进行访问。</span><span
lang=EN-US style='background:#D9D9D9;mso-shading:white;mso-pattern:gray-15 auto'><o:p></o:p></span></i></p>

<h2><span style='font-family:黑体;mso-ascii-font-family:Arial'>内核任务</span></h2>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>这里所定义的内核任务是指内核中执行的一切活动对象，每个内核任务都拥有一个独立的程序计数器、<span
class=GramE>栈</span>和一组寄存器。更重要的是,它们都属于内核调度（这里的调度是广义上的，不要与进程调度混淆）对象，也就是说它们是可以在内核中交错执行的。</span></p>

<h3><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>内核任务分类</span></h3>

<p class=MsoNormal style='text-indent:21.75pt'><span style='font-family:宋体;
mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>内核任务包含“内核线程”、“系统调用”、“硬件中断”、“半底任务”等几类。下来我们就简要地讨论上述几类内核任务的特点。</span></p>

<h4><span style='font-family:黑体;mso-ascii-font-family:Arial'>系统调用</span></h4>

<p class=MsoNormal style='layout-grid-mode:char'><i><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp; </span><span  
style='mso-spacerun:yes'>&nbsp;</span></span></i><span style='font-family:宋体;
mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>系统调用是用户程序通过<span
class=GramE>门机制</span>来进入内核执行的内核例程，它运行在内核态，处于进程上下文中（进程上下文包括进程的堆栈等等环境），可以认为是代表用户进程的内核任务，因此具有用户<span
class=GramE>态任务</span>的特性，比如可以执行进程调度程序（</span><span lang=EN-US>schedule()</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>）、可以睡眠、可以访问当前进程数据（通过</span><span lang=EN-US>current</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>）。但它属于内核任务，所以在执行过程中不能被抢占（</span><span lang=EN-US>2.6</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>内核前），只能自己放弃</span><span class=SpellE><span lang=EN-US>cpu</span></span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>（睡眠）时，系统才能可能重新调度别的任务。（有关系统调用部分请看《系统调用》一章）</span></p>

<h4><span style='font-family:黑体;mso-ascii-font-family:Arial'>硬中断任务</span></h4>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0;
layout-grid-mode:char'><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>硬中断是指那些由处理器以外的外设产生的中断，这些中断被处理器接收后交给内核中的中断处理程序处理。要注意的是：第一</span><span
lang=EN-US>, </span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman"; 
mso-hansi-font-family:"Times New Roman"'>硬中断是异步产生的，中断发生后立刻得到处理，也就是说中断操作可以抢占内核中正在运行的代码。这点非常重要。第二，中断操作是发生在中断上下文中的（所谓中断上下文指的是和任何进程无关的上下文环境）。中断上下文中不可以使用进程相关的资源，也不能够进行调度或睡眠。因为调度会引起睡眠，但睡眠必须针对进程而言（睡眠其实是标记进程状态，然后把当前进程推入睡眠列队），而异步发生的中断处理程序根本不知道当前进程的任何信息，也不关心当前哪个进程在运行，它完全是个过客。（有关硬件中断部分请看《硬件中断》一章）</span></p>

<h4><span class=GramE><span style='font-family:黑体;mso-ascii-font-family:Arial'>下半底任务</span></span></h4>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
class=GramE><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>半底的</span></span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>来历完全出自上面提到的硬中断的影响。硬件中断任务（处理程序）是一个快速、异步、简单地对硬件做出迅速响应并在最短时间内完成必要操作的中断处理程序。硬中断处理程序可以抢占内核任务并且执行时还会屏蔽同级中断或其它中断，因此中断处理必须要快、不能阻塞。这样一来对于一些要求处理过程比较复杂的任务就不合适在中断任务中一次处理。比如，网卡接收数据的过程中,首先网卡发送中断信号告诉</span><span
lang=EN-US>CPU</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>来取数据，然后系统从网卡中读取数据存入系统缓冲区中，再下来解析数据然后送入应用层。这些如果都让中断处理程序来处理显然过程太长，造成新来的中断丢失。因此</span><span
lang=EN-US>Linux</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>开发人员将这种任务分割为两个部分，一个叫上底，即中断处理程序，短平快地处理与硬件相关的操作（如从网卡读数据到系统缓存）；而把对时间要求相对宽松的任务（如解析数据的工作）放在另一个部分执行，这个部分就是我们这里要讲的<span
class=GramE>下半底</span>。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
class=GramE><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>下半底是</span></span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>一种推后执行任务，它将某些不那么紧迫的任务推迟到系统更方便的时刻运行。内核中实现<span class=GramE>下半底的</span>手段经过不断演化，目前已经从最原始的</span><span
lang=EN-US>BH(bottom <span class=SpellE>thalf</span>)</span><span  
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>演生出</span><span lang=EN-US>BH</span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>、任务队列（</span><span
lang=EN-US>Task queues</span><span style='font-family:宋体;mso-ascii-font-family:  
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>）、软中断（</span><span
class=SpellE><span lang=EN-US>Softirq</span></span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>）、</span><span
class=SpellE><span lang=EN-US>Tasklet</span></span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>、工作队列（</span><span
lang=EN-US>Work queues</span><span style='font-family:宋体;mso-ascii-font-family:  
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>）（</span><span
lang=EN-US>2.6</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>内核中新出现的）。下面我们就介绍一下他们各自的特点。</span><span
lang=EN-US><o:p></o:p></span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></p>

<h5><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>软中断操作</span></h5>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0;
layout-grid-mode:char'><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>软中断（</span><span class=SpellE><span
lang=EN-US>softirq</span></span><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>）<span class=GramE>不象</span>硬中断那样是由硬件中断信号触发执行的，所以也不同于硬件中断那样时随时都能够被执行，笼统来讲,软中断会在内核处理任务完毕后返回用户级程序前得到处理机会。<i><b
style='mso-bidi-font-weight:normal'>具体的讲</b><b
style='mso-bidi-font-weight: normal; font-family: 宋体; mso-ascii-font-family: Times New Roman; mso-hansi-font-family: Times New Roman'>,</b><b
style='mso-bidi-font-weight:normal'>有三个时刻它将被执行</b></i></span><b
style='mso-bidi-font-weight:normal'><i><span lang=EN-US>(<span class=SpellE>do_softirq</span>())</span></i></b><i><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'><b
style='mso-bidi-font-weight:normal'>：硬件中断操作完成后；系统调用返回时；内核调度程序中；（另外</b><b
style='mso-bidi-font-weight: normal; font-family: 宋体; mso-ascii-font-family: Times New Roman; mso-hansi-font-family: Times New Roman'>,</b><b
style='mso-bidi-font-weight:normal'>内核线程</b></span><b
style='mso-bidi-font-weight:normal'><span
class=SpellE><span lang=EN-US>ksoftirqd</span></span></b></i><b
style='mso-bidi-font-weight:normal'><i><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>周期执行软中断）</span></i></b><b
style='mso-bidi-font-weight:normal'><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>。</span></b><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>从中可以看出软中断会紧随硬中断处理</span><span lang=EN-US>(</span><span
class=GramE><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>好象狐假虎威</span></span><span lang=EN-US>),</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>所以抢占内核任务――<span style='color:black'>至少在时钟中断后总有机会运行一次。</span>还要记得软中断可以在<span
class=GramE>不同处器上</span>并发执行。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0;
layout-grid-mode:char'><span style='font-family:宋体;mso-ascii-font-family:东文宋体;
mso-hansi-font-family:东文宋体;background:#D9D9D9;mso-shading:white;mso-pattern:
gray-15 auto'>在有对称多处理器的机器上，那么两个任务就可以真正的在临界区中同时执行了，这种类型被称为<i style='mso-bidi-font-style:
normal'>真并发</i>。相对而言在,单处理器上并发其实并不是真的同时发生，而是相互交错执行，是<i style='mso-bidi-font-style:
normal'>伪并发</i>。<i style='mso-bidi-font-style:normal'>但它们都同样会造成竞争条件，而且也需要同样的保护。</i></span><span
lang=EN-US><o:p></o:p></span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0;
layout-grid-mode:char'><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>软中断是<span class=GramE>很</span>底层的机制，一般除了在网络子系统和</span><span
lang=EN-US>SCSI</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>子系统这样对性能要求很高以及要求并发处理的时候，才会选择使用软中断。软中断虽然灵活性高和效率高，但是你自己必须处理复杂的同步处理（因为它可在多处理器上并发），所以通常都不直接使用，而是作为支持</span><span
class=SpellE><span lang=EN-US>Tasklet</span></span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>和</span><span
lang=EN-US>BH</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>的根本。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0;
layout-grid-mode:char'><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>需要说明的是,软中断的执行也处于中断上下文中，所以中断上下文对它的限制是和硬中断一样的。</span></p>

<h5><span class=SpellE><span lang=EN-US>Tasklet</span></span><span lang=EN-US> </span></h5>

<p class=MsoPlainText style='layout-grid-mode:char'><b><i><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span><span
style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-spacerun:yes'>&nbsp;</span></span></i></b><span class=SpellE><span
lang=EN-US>Tasklet</span></span>和<span lang=EN-US>bottom half都是建立在软中断之上的两种延迟机制，其具体不同之处在于软中断是静态分配的，而且同类软中断可以并发地在几个CPU上运行；<span 
class=SpellE>Tasklet</span>可以动态分配，并且不同种类的<span class=SpellE>Tasklets</span>可以并发地在几个CPU上运行，但同类的<span
class=SpellE>tasklets</span> 不可以；bottom half只能静态分配，实质上,下半部分是一个不能与其它下半部分并发执行的高优先级<span 
class=SpellE>tasklet</span>，即使它们类型不同，而且在不同CPU上运行。<span class=SpellE>Tasklet</span>可以理解为软中断的派生，所以它的调度时机与软中断一致。</span></p>

<p class=MsoPlainText style='layout-grid-mode:char'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span><span
style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-spacerun:yes'>&nbsp;</span>对于内核中需要延迟执行的多数任务都可以利用<span class=SpellE>tasklet</span>来完成，由于同类<span
class=SpellE>tasklet</span>本身已经进行了同步保护，所以使用<span class=SpellE>tasklet</span>相比软中断要简单得多，而且效率也不错。</span></p>

<h5><span class=GramE><span lang=EN-US>bottom</span></span><span lang=EN-US>
half</span></h5>

<p class=MsoNormal><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;&nbsp; 
是</span><span style='mso-spacerun:yes'>&nbsp;</span>BH</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>时最早的内核延迟方法，它原始、简单且容易控制，因为所有的</span><span lang=EN-US>BH</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>处理程序都被严格地顺序执行――不允许任何两个</span><span lang=EN-US>BH</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>处理程序同时并发执行，即使它们的类型不同也不可以，这样一来</span><span lang=EN-US>BH</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>执行其间减少了许多同步保护。但是</span><span lang=EN-US>BH</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>不得不被淘汰，因为它的“简便”牺牲了多处理器并发处理的高性能，等于一队人过独木桥那样速度受到牵制。</span><span
lang=EN-US><o:p></o:p></span></p>

<h5><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>任务队列</span></h5>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>任务列队是</span><span lang=EN-US>BH</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>的替代品，来自</span><span lang=EN-US>BH</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>，所以它的属性也和</span><span lang=EN-US>BH</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>相同。它的原意在于简化</span><span lang=EN-US>BH</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>的操作接口，但它的随意性（数量随意、执行时机随意）却给系统带来了混乱，所以到今天已经被工作队列（在</span><span
lang=EN-US>2.6</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>内核中）所取代。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>不过在</span><span lang=EN-US>2.4</span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>内核中任务队列还是被大量应用，尤其是调度队列、定时器队列和立即队列等三种任务队列（除了这三种系统已接管的特定任务队列外，你自己也可随心所欲的建立自己的任务队列，当然这时你要自己调度它）。调度队列的任务会在每次进程调度时得到处理，它是在进程上下文中处理的；定时器队列会在每次时钟滴答时得到处理；立即队列会在<span
style='color:red'>中断</span>返回或调度时获得处理（所以处理最快），他们都是在中断上下文中处理的。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>这些任务队列在内核内由一个统一的内核线程调度，该线程名为</span><span class=SpellE><span
lang=EN-US>keventd</span></span><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>，进程号是</span><span
lang=EN-US>2</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>（</span><span lang=EN-US>2.4.18</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>）。你可用</span><span class=SpellE><span lang=EN-US>ps</span></span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>命令查看到该进程。</span></p>

<h4><span style='font-family:黑体;mso-ascii-font-family:Arial'>内核线程</span></h4>

<p class=MsoNormal style='text-indent:21.75pt'><span style='font-family:宋体;
mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>内核线程可以理解成在内核中运行的特殊进程，它有自己的“进程上下文”（借用调用它的用户进程的上下文），所以同样被进程调度程序调度，也可以睡眠――它和用户进程属性何其相似，不同之处就在于内核线程运行于内核空间，可访问内核数据，运行期间不能被抢占。</span></p>

<p class=MsoPlainText style='text-indent:21.0pt;mso-char-indent-count:2.0'>传统的<span
lang=EN-US>Unix系统把一些重要的任务委托给周期性执行的进程，这些任务包括刷新磁盘高速缓存，交换出不用<span class=GramE>的页</span></span><span class=GramE>面</span><span
lang=EN-US>，维护网络链接等等。事实上，以严格线性的方式执行这些任务的确效率不高，如果把他们放在后台调度，不管是对它们的函数还是对终端用户进程都能得到较好地响应。因为一些系统进程只运行在内核态，现代操作系统把它们的函数委托给内核线程（Kernel  
Thread），内核线程不受不必要的用户态上下文的拖累。</span></p>

<h2><span style='font-family:黑体;mso-ascii-font-family:Arial'>内核中的同步</span></h2>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>内核只要存在任务交错执行，就必然会存在对共享数据的并发问题，也就必然存在对数据的保护。而内核中任务交错执行的原因归根结底还是由于内核任务调度造成的。我们下面归纳一下内核中同步的原因。</span></p>

<h3><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>同步原因</span></h3>

<p class=MsoNormal style='margin-left:21.0pt;text-indent:-21.0pt;mso-list:l8 level1 lfo1;
tab-stops:list 21.0pt'><![if !supportLists]><span lang=EN-US style='font-family:
Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:Wingdings'><span
style='mso-list:Ignore'>l<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
</span></span></span><![endif]><span style='font-family:宋体;mso-ascii-font-family:
东文宋体;mso-hansi-font-family:东文宋体'>中断</span><span lang=EN-US style='font-family:
东文宋体'>――</span><span style='font-family:宋体;mso-ascii-font-family:东文宋体;
mso-hansi-font-family:东文宋体'>中断几乎可以在任何时刻异步发生，也就可能随时打断当前正在执行的代码。</span><span
lang=EN-US style='font-family:东文宋体'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:21.0pt;text-indent:-21.0pt;mso-list:l8 level1 lfo1;
tab-stops:list 21.0pt'><![if !supportLists]><span lang=EN-US style='font-family:
Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:Wingdings'><span
style='mso-list:Ignore'>l<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
</span></span></span><![endif]><span style='font-family:宋体;mso-ascii-font-family:
东文宋体;mso-hansi-font-family:东文宋体;color:black'>睡眠及与用户空间的同步</span><span
lang=EN-US style='font-family:东文宋体'>――</span><span style='font-family:宋体;
mso-ascii-font-family:东文宋体;mso-hansi-font-family:东文宋体'>在内核执行的进程可能会睡眠，这就会唤醒调度程序，从而导致调度一个新的用户进程执行。</span><span
lang=EN-US style='font-family:东文宋体'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:21.0pt;text-indent:-21.0pt;mso-list:l8 level1 lfo1;
tab-stops:list 21.0pt'><![if !supportLists]><span lang=EN-US style='font-family:
Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:Wingdings'><span
style='mso-list:Ignore'>l<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
</span></span></span><![endif]><span style='font-family:宋体;mso-ascii-font-family:
东文宋体;mso-hansi-font-family:东文宋体'>对称多处理</span><span lang=EN-US style='font-family:
东文宋体'>――</span><span style='font-family:宋体;mso-ascii-font-family:东文宋体;
mso-hansi-font-family:东文宋体'>两个或多个处理器可以同时执行代码。</span><span lang=EN-US
style='font-family:东文宋体'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:21.0pt;text-indent:-21.0pt;mso-list:l8 level1 lfo1;
tab-stops:list 21.0pt'><![if !supportLists]><span lang=EN-US style='font-family:
Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:Wingdings'><span
style='mso-list:Ignore'>l<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
</span></span></span><![endif]><span style='font-family:宋体;mso-ascii-font-family:
东文宋体;mso-hansi-font-family:东文宋体'>内核抢占</span><span lang=EN-US style='font-family:
东文宋体'>――</span><span style='font-family:宋体;mso-ascii-font-family:东文宋体;
mso-hansi-font-family:东文宋体'>因为内核具有抢占性，所以内核中的任务可能会被另一任务抢占（在</span><span
lang=EN-US style='font-family:东文宋体'>2.6</span><span style='font-family:宋体;
mso-ascii-font-family:东文宋体;mso-hansi-font-family:东文宋体'>内核引进的新能力）。</span><span
lang=EN-US style='font-family:东文宋体'><o:p></o:p></span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:东文宋体;mso-hansi-font-family:东文宋体;
background:#D9D9D9;mso-shading:white;mso-pattern:gray-15 auto'>后两种情况大大增加了内核任务并发执行的可能性，使得并发<span
class=GramE>随时随刻都有</span>可能发生，而且不可清晰预见，规律难寻。</span><span lang=EN-US
style='font-family:东文宋体;background:#D9D9D9;mso-shading:white;mso-pattern:gray-15 auto'><o:p></o:p></span></p>

<h3><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>内核任务之间的并发关系</span><span lang=EN-US><o:p></o:p></span></h3>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0;
layout-grid-mode:char'><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>上述内核任务很多情况是可以交错执行的――记住，一个下半部实际上可能在任何时候执行，所以很有可能产生竞争（都要访问同一个数据结构时，就产生了竞争）。下面分析这些内核任务之间有哪些可能的并发行为。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0;
layout-grid-mode:char'><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>可以抽象出，程序（用户态和内核态一样）并发执行的<span
class=GramE>总原因</span>无非是正在运行中的程序被其它程序<i>抢占</i>，所以我们必须看看内核任务之间的抢占关系：</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0;
layout-grid-mode:char'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='margin-left:42.0pt;text-indent:-21.0pt;mso-list:l3 level2 lfo4;
tab-stops:list 42.0pt;layout-grid-mode:char'><![if !supportLists]><span
lang=EN-US style='font-family:Wingdings;mso-fareast-font-family:Wingdings;
mso-bidi-font-family:Wingdings'><span style='mso-list:Ignore'>n<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
</span></span></span><![endif]><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>中断处理程序可以抢占内核中的所有程序（当没有锁保护时），包括软中断，</span><span
class=SpellE><span lang=EN-US>tasklet</span></span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>，</span><span
lang=EN-US>bottom half</span><span style='font-family:宋体;mso-ascii-font-family:  
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>和系统的调用、内核线程，甚至也包括硬中断处理程序。也就是说中断处理程序可以和这些所有的内核任务并发执行，如果被抢占的程序和中断处理程序都要访问同一个资源，就必然有可能产生竞争。</span></p>

<p class=MsoBodyTextIndent style='margin-left:42.0pt;text-indent:-21.0pt;
mso-char-indent-count:0;mso-list:l3 level2 lfo4;tab-stops:list 42.0pt;
layout-grid-mode:char'><![if !supportLists]><span lang=EN-US style='font-family:
Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:Wingdings'><span
style='mso-list:Ignore'>n<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
</span></span></span><![endif]><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>软件中断也可以抢占内核中的所有任务，所以内核代码（比如，系统调用、内核线程等）中有数据和软中断共享，就会有竞争――除此外硬件中断处理程序也有可能被软中断打断，条件是硬中断被其它硬中断打断，软中断随即便获得了执行机会，因为软中断是跟在硬中断后执行的。此外要注意的是，软中断即使是同种类型的也可以并发地运行在不同处理器上，所以它们之间共享数据都会产生竞争。（如果在同一个处理器上,软中断之间是不能相互抢占的）。</span></p>

<p class=MsoBodyTextIndent style='margin-left:42.0pt;text-indent:-21.0pt;
mso-char-indent-count:0;mso-list:l3 level2 lfo4;tab-stops:list 42.0pt;
layout-grid-mode:char'><![if !supportLists]><span lang=EN-US style='font-family:
Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:Wingdings'><span
style='mso-list:Ignore'>n<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
</span></span></span><![endif]><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>同类的</span><span
class=SpellE><span lang=EN-US>tasklet</span></span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>不可能同时运行，所以对于同类</span><span
class=SpellE><span lang=EN-US>tasklet</span></span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>之间是串行运行的，他们不会产生并发；但两个不同种类的</span><span
class=SpellE><span lang=EN-US>tasklet</span></span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>有可能在不同处理器上并发运行，如果之间有数据共享就会产生竞争（在同一个处理器上运行的</span><span
class=SpellE><span lang=EN-US>tasklet</span></span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>不发生相互抢占的情况）。</span></p>

<p class=MsoBodyTextIndent style='margin-left:42.0pt;text-indent:-21.0pt;
mso-char-indent-count:0;mso-list:l7 level2 lfo8;tab-stops:list 42.0pt;
layout-grid-mode:char'><![if !supportLists]><span lang=EN-US style='font-family:
Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:Wingdings'><span
style='mso-list:Ignore'>n<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
</span></span></span><![endif]><span lang=EN-US>Bottom half </span><span  
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>无论是否是同类的，即使在不同处理器上也都不能并发执行，它是绝对串行化的，所以它们之间永远不能产生竞争。任务列队属性基本同</span><span
lang=EN-US>BH</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>。</span><span lang=EN-US><o:p></o:p></span></p>

<p class=MsoBodyTextIndent style='margin-left:42.0pt;text-indent:-21.0pt;
mso-char-indent-count:0;mso-list:l4 level2 lfo10;tab-stops:list 42.0pt;
layout-grid-mode:char'><![if !supportLists]><span lang=EN-US style='font-family:
Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:Wingdings'><span
style='mso-list:Ignore'>n<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
</span></span></span><![endif]><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>系统调用和内核线程这种运行在进程上下文中的内核任务可能和各种内核任务并发，除了上面提到的中断（软，硬）来抢占它而产生并发外，它也有可能自发性地主动睡眠（比如在一些阻塞性的操作中），放弃处理器，重新调度其它任务，所以系统调用和内核线程除会与软硬中断（半底等）发生竞争，也会与其他（包括自己）系统调用与内核线程发生竞争。我们尤其要注意这种情况。</span></p>

<p class=MsoBodyTextIndent style='margin-left:8.9pt;mso-para-margin-left:.85gd;
layout-grid-mode:char'><i><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman";background:#D9D9D9;
mso-shading:white;mso-pattern:gray-15 auto'>注意：</span><span class=SpellE><span
lang=EN-US style='background:#D9D9D9;mso-shading:white;mso-pattern:gray-15 auto'>tasklet</span></span></i><i><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman";background:#D9D9D9;mso-shading:white;mso-pattern:gray-15 auto'>和</span><span
lang=EN-US style='background:#D9D9D9;mso-shading:white;mso-pattern:gray-15 auto'>bottom  
half</span></i><i><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";background:#D9D9D9;mso-shading:white;
mso-pattern:gray-15 auto'>是建立在软中断之上的，所以它们也都遵从软中断的调度规则――都可以打断进程上下文中的内核代码（系统调用），都可被硬中断打断――这些情况下都可能产生并发。</span><span
lang=EN-US style='background:#D9D9D9;mso-shading:white;mso-pattern:gray-15 auto'><o:p></o:p></span></i></p>

<h2><span style='font-family:黑体;mso-ascii-font-family:Arial'>内核同步措施</span></h2>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>为了避免并发，防止竞争。内核提供了一组同步方法来提供对共享数据的保护。</span> <span 
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>我们的重点不是介绍这些方法的详细用法，而是强调为什么使用这些方法和它们之间的差别。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; Linux</span><span style='font-family:宋体;
mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>使用的同步机制可以说从</span><span
lang=EN-US>2.0</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>到</span><span lang=EN-US>2.6</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>以来不断发展完善。从最初的原子操作，到后来的信号量，从大内核锁到今天的自旋锁。这些同步机制的发展伴随</span><span
lang=EN-US>&nbsp;&nbsp;&nbsp; Linux</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman"; 
mso-hansi-font-family:"Times New Roman"'>从单处理器到对称多处理器的过度；伴随着从非抢占内核到抢占内核的过度。<span
class=GramE>锁机制</span>越来越有效，也越来越复杂。</span></p>

<p class=MsoNormal>&nbsp;&nbsp;&nbsp; <span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>目前来说内核中原子操作多用来做计数使用，其它情况最常用的是两重锁以及它们的变种，一个是自旋锁，另一个是信号量。我们下面就来着重介绍一下这两<span
class=GramE>种锁机制</span>。</span></p>

<h3><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>自旋锁</span></h3>

<p class=MsoNormal style='text-indent:21.75pt'><span style='font-family:宋体;
mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>自旋锁是专为防止多处理器并发而引入的一种锁，它在内核中大量应用于中断处理等部分（对于单处理器来说，防止中断处理中的并发可简单采用关闭中断的方式，不需要自旋锁）。</span><span
lang=EN-US><o:p></o:p></span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>自旋锁最多只能被一个内核任务持有，如果一个内核任务试图请求一个已被争用（已经被持有）的自旋锁，那么这个任务就会一直进行忙循环――旋转――等待<span
class=GramE>锁重新</span>可用。<span class=GramE>要是锁</span>未被争用，请求它的内核任务便能立刻得到它并且继续进行。自旋<span
class=GramE>锁可以</span>在任何时刻防止多于一个的内核任务同时进入临界区，因此<span class=GramE>这种锁可有效</span>地避免多处理器上并发运行的内核任务竞争共享资源。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>事实上，自旋锁的初衷就是：在短期间内进行轻量级的锁定。一个被争用的自旋锁使得请求它的线程在等待<span
class=GramE>锁重新</span>可用的期间进行自旋（特别浪费处理器时间），所以自旋锁不应该被持有时间过长。如果需要长时间锁定</span><span
lang=EN-US>的话, </span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman"; 
mso-hansi-font-family:"Times New Roman"'>最好使用信号量。</span></p>

<p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>自旋锁的基本形式如下：</span></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
class=SpellE><span lang=EN-US>spin_<span class=GramE>lock</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>&amp;<span
class=SpellE>mr_lock</span>);</span></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
lang=EN-US>/*</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>临界区</span><span lang=EN-US>*/</span></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
class=SpellE><span lang=EN-US>spin_<span class=GramE>unlock</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>&amp;<span
class=SpellE>mr_lock</span>);</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>因为自旋锁在同一时刻只能被最多一个内核任务持有，所以一个时刻只有一个线程允许存在于临界区中。这点很好地满足了对称多处理机<span
class=GramE>器需要</span>的锁定服务。在单处理器上，自旋锁仅仅当作一个设置内核抢占的开关。如果内核抢占也不存在，那么<span
class=GramE>自旋锁会在</span>编译时被完全剔除出内核。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>自旋锁在内核中有许多变种，如对</span><span lang=EN-US>bottom half&nbsp;</span><span  
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>而言，可以使用</span><span class=SpellE><span lang=EN-US>spin_lock_bh</span></span><span
lang=EN-US>()</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>用来获得特定<span class=GramE>锁并且关闭半底执行</span>。相反的操作由</span><span
class=SpellE><span lang=EN-US>spin_unlock_bh</span></span><span lang=EN-US>()</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>来执行；<span style='color:black'>如果临界区的访问逻辑可以被清晰的分为读和写这种模式，那么可以使用读者</span></span><span
lang=EN-US style='color:black'>/</span><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman";color:black'>写者自旋</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>锁，调用形式为：</span></p>

<p class=MsoNormal><i><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>读者的代码路径：</span><span lang=EN-US><o:p></o:p></span></i></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
class=SpellE><i><span lang=EN-US>read_<span class=GramE>lock</span></span></i></span><span
class=GramE><i><span lang=EN-US>(</span></i></span><i><span lang=EN-US>&amp;<span
class=SpellE>mr_rwlock</span>);<o:p></o:p></span></i></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><i><span
lang=EN-US>/*</span></i><i><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>只读临界区</span><span
lang=EN-US>*/<o:p></o:p></span></i></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
class=SpellE><i><span lang=EN-US>read_<span class=GramE>unlock</span></span></i></span><span
class=GramE><i><span lang=EN-US>(</span></i></span><i><span lang=EN-US>&amp;<span
class=SpellE>mr_rwlock</span>);<o:p></o:p></span></i></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><i><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>写者的代码路径：</span><span lang=EN-US><o:p></o:p></span></i></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
class=SpellE><i><span lang=EN-US>write_<span class=GramE>lock</span></span></i></span><span
class=GramE><i><span lang=EN-US>(</span></i></span><i><span lang=EN-US>&amp;<span
class=SpellE>mr_rwlock</span>);<o:p></o:p></span></i></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><i><span
lang=EN-US>/*</span></i><i><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>读写临界区</span><span
lang=EN-US>*/<o:p></o:p></span></i></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
class=SpellE><i><span lang=EN-US>write_<span class=GramE>unlock</span></span></i></span><span
class=GramE><i><span lang=EN-US>(</span></i></span><i><span lang=EN-US>&amp;<span
class=SpellE>mr_rwlock</span>);<o:p></o:p></span></i></p>

<p class=MsoNormal><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;  
</span><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span></span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>简单的说，自旋锁在内核中主要用来防止多处理器中并发访问临界区，防止内核抢占造成的竞争。另外自旋锁不允许任务睡眠（持有自旋锁的任务睡眠会造成自死锁――因为睡眠有可能造成持有锁的内核任务被重新调度，而再次申请自己已持有的锁），它能够在中断上下文中使用。</span></p>

<p class=MsoNormal>&nbsp;&nbsp;&nbsp; <span style='font-family:宋体;mso-ascii-font-family:"Times New Roman"; 
mso-hansi-font-family:"Times New Roman";background:#D9D9D9;mso-shading:white;
mso-pattern:gray-15 auto'>死锁：假设有</span><span style='font-family:宋体;mso-ascii-font-family:
东文宋体;mso-hansi-font-family:东文宋体;background:#D9D9D9;mso-shading:white;
mso-pattern:gray-15 auto'>一个或多个内核任务和一个或多个资源，每个内核都在等待其中的一个资源，但所有的资源都已经被占用了。这便会发生所有内核任务都在相互等待，<span
style='color:black'>但它们永远不会释放已经占有的资源，于是任何内核任务都无法获得所需要的资源，无法继续运行，这便意味着死锁发生了。自死<span
class=GramE>琐</span>是说自己占有了某个资源，然后自己又申请自己已占有的资源，显然不可能再获得该资源，因此就自缚手脚了。</span></span><span
lang=EN-US style='background:#D9D9D9;mso-shading:white;mso-pattern:gray-15 auto'><o:p></o:p></span></p>

<h3><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>信号量</span><span lang=EN-US> </span></h3>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
lang=EN-US>Linux</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>中的信号量是一种睡眠锁。如果有一个任务试图获得一个已被持有的信号量时，信号量会将其推入等待队列，然后让其睡眠。这时处理器获得自由去执行其它代码。当持有信号量的进程将信号量释放后，在等待队列中的一个任务将被唤醒，从而便可以获得这个信号量。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>信号量的睡眠特性，使得信号量<span class=GramE>适用于锁会被</span>长时间持有的情况；只能在进程上下文中使用，因为中断上下文中是不能被调度的；另外当代码持有信号量时，不可以再持有自旋锁。</span></p>

<p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>信号量基本使用形式为：</span></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
lang=EN-US style='color:black'>static DECLARE_MUTEX(<span class=SpellE>mr_sem</span>);//</span><span  
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman";color:black'>声明互斥信号量</span><span lang=EN-US style='color:
black'><o:p></o:p></span></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
lang=EN-US style='color:black'>…<o:p></o:p></span></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
class=GramE><span lang=EN-US style='color:black'>if(</span></span><span
class=SpellE><span lang=EN-US style='color:black'>down_interruptible</span></span><span
lang=EN-US style='color:black'>(&amp;<span class=SpellE>mr_sem</span>))<o:p></o:p></span></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
lang=EN-US style='color:black'>/*</span><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman";color:black'>可被中断的睡眠，当信号来到，睡眠的任务被唤醒</span><span
lang=EN-US style='color:black'> */<o:p></o:p></span></p>  

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
lang=EN-US style='color:black'>/*</span><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman";color:black'>临界区</span><span
lang=EN-US style='color:black'>…*/<o:p></o:p></span></p>

<p class=MsoNormal style='text-indent:10.5pt;mso-char-indent-count:1.0'><span
class=GramE><span lang=EN-US style='color:black'>up(</span></span><span
lang=EN-US style='color:black'>&amp;<span class=SpellE>mr_sem</span>);<o:p></o:p></span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman";color:black'>同自旋锁一样，信号量</span><span style='font-family:宋体;
mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>在内核中也有许多变种，比如读者－写者信号量等，这里不再做介绍了。</span><span
lang=EN-US style='color:black'><o:p></o:p></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span><b><i><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>信号量和自旋锁区别</span><span
lang=EN-US><o:p></o:p></span></i></b></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>虽然听起来两者之间的使用条件复杂，其实在实际使用中信号量和<span class=GramE>自旋锁并不易</span>混淆。注意以下原则。</span></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>如果代码需要睡眠――这往往是发生在和用户空间同步时――使用信号量是唯一的选择。由于不受睡眠的限制，使用信号量通常来说更加简单一些。如果需要在自旋锁和信号量中作选择，应该<span
class=GramE>取决于锁被持有</span>的时间长短。理想情况是所有<span class=GramE>的锁都应该</span>尽可能短的被持有，但是<span
class=GramE>如果锁</span>的持有时间较长的话，使用信号量是更好的选择。另外，信号量不同于自旋锁，它不会关闭内核抢占，所以持有信号量的代码可以被抢占。这意味者信号量不会对影响调度反应时间带来负面影响。</span></p>

<p class=MsoNormal><span class=GramE><b><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman";color:black'>自旋锁对信号量</span></b></span><b><span
lang=EN-US style='color:black'><o:p></o:p></span></b></p>

<p class=MsoNormal><b><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>D<span class=GramE>DDDDDDDDDDDDDDDDDDDD</span>DDDDDDDDDD</span><span
lang=EN-US style='color:black'><o:p></o:p></span></b></p>

<p class=MsoNormal><b><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>&nbsp;&nbsp;&nbsp; 需求</span><span lang=EN-US
style='color:black'><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</span></span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>建议的加锁方法</span><span
lang=EN-US style='color:black'><o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>低开销加锁</span><span
lang=EN-US style='color:black'><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
优先使用自旋锁</span><span
lang=EN-US style='color:black'><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>短期</span><span style="font-family: 宋体; mso-ascii-font-family: Times New Roman; mso-hansi-font-family: Times New Roman; color: black">锁定</span><span
lang=EN-US style='color:black'><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span 
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman";color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 优先使用自旋锁</span><span lang=EN-US style='color:
black'><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>长期加锁</span><span
lang=EN-US style='color:black'><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</span></span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>优先使用信号量</span><span
lang=EN-US style='color:black'><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>中断上下文中加锁</span><span
lang=EN-US style='color:black'><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</span></span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>使用自旋锁</span><span
lang=EN-US style='color:black'><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>持有锁是需要睡眠、调度</span><span
lang=EN-US style='color:black'><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
</span></span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>使用信号量</span><span
lang=EN-US style='color:black'><o:p></o:p></span></p>

<p class=MsoNormal><b><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";color:black'>D<span class=GramE>DDDDDDDDDDDDDDDDDDDD</span>DDDDDDDDDD</span><span
lang=EN-US style='color:black'><o:p></o:p></span></b></p>

<p class=MsoNormal style='text-indent:210.0pt;mso-char-indent-count:20.0'><i
style='mso-bidi-font-style:normal'><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>引自</span> </i><i  
style='mso-bidi-font-style:normal'><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>《</span><span
lang=EN-US>Linux</span></i><i style='mso-bidi-font-style:normal'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>内核开发》</span><span lang=EN-US><o:p></o:p></span></i></p>

<p class=MsoNormal style='text-indent:21.0pt;mso-char-indent-count:2.0'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>防止并发的方式除了上面提到的外还有很多，我们不详细介绍了。说了这么多,希望大家认识到，并发控制在内核编程中是个特别难缠的问题，要驾御它必须清楚地认识到内核中各种任务的调度时机与特点，并且在开发初期就应特别小心保护共享数据（一切共享数据、一切能被别人看到的数据都要注意保护），别等到开发完成才去亡羊补牢。</span></p>

<h2><span style='font-family:黑体;mso-ascii-font-family:Arial'>并发控制实例</span></h2>

<p class=MsoNormal>&nbsp;&nbsp;&nbsp;<span style="mso-spacerun: yes" lang="EN-US"> 
</span><span 
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>我们下面给出一个多内核任务访问共享资源的具体例子，其中会用到上面提到的各种同步方法，希望能给大家一个形象的记忆。</span></p>

<p class=MsoNormal>&nbsp;&nbsp;&nbsp;<span style="mso-spacerun: yes" lang="EN-US">&nbsp;</span><span
style='mso-spacerun:yes' lang="EN-US"> </span><span  
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>该例子的具体场景描述如下。</span></p>

<p class=MsoNormal>&nbsp;&nbsp;&nbsp; <span 
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>我们主要的共享资源是链表（</span><span lang=EN-US>mine</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>）</span><span lang=EN-US>,</span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>操作它的内核任务有三种：一个是</span><span
lang=EN-US>100</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>个内核线程（</span><span class=SpellE><span
lang=EN-US>sharelist</span></span><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>），它们负责从表头将新节点（</span><span
class=SpellE><span lang=EN-US>struct</span></span><span lang=EN-US> <span
class=SpellE>my_struct</span></span><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>）插入链表。二是定时器任务</span><span
lang=EN-US>(<span class=SpellE>qt_task</span>)</span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>，它负责每个时钟滴答时从链表头删除一个节点。三是系统调用（由</span><span
class=SpellE><span lang=EN-US>rmmod</span></span><span style='font-family:宋体;
mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>命令调用的</span><span
class=SpellE><span lang=EN-US>share_exit</span></span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>），它负责销毁链表并卸载模块。</span><span
lang=EN-US><o:p></o:p></span></p>

<p class=MsoNormal>&nbsp;&nbsp;&nbsp;<span style="mso-spacerun: yes" lang="EN-US"> 
</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>我们利用模块（</span><span class=SpellE><span lang=EN-US>sharelist.o</span></span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>）实现上述场景。加载模块时会建立定时器任务列队，并将要执行的任务</span><span lang=EN-US>(<span
class=SpellE>task.rounting</span>=<span class=SpellE>qt_task</span>)</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>插入定时器队列（</span><span class=SpellE><span lang=EN-US>tq_timer</span></span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>），然后反复调度执行（但别不停地执行）。与此同时利用系统中的</span><span class=SpellE><span
lang=EN-US>keventd</span></span><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>内核线程（它的目的是执行任务队列</span><span
lang=EN-US>,</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>由</span><span class=SpellE><span
lang=EN-US>schedule_task</span></span><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>激活，</span><span
lang=EN-US>PID=2</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>），创建</span><span lang=EN-US>100</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>个内核线程</span><span lang=EN-US>(</span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>创建函数</span><span
class=SpellE><span lang=EN-US>kernel_thread</span></span><span lang=EN-US>)</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>执行插入链表的工作（由</span><span class=SpellE><span lang=EN-US>sharelist</span></span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>完成）――但当链表长度超过</span><span lang=EN-US>100</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>时，则从链表尾删除节点。最后当你需要卸载模块时，调用</span><span class=SpellE><span
lang=EN-US>share_exit</span></span><span style='font-family:宋体;mso-ascii-font-family:
"Times New Roman";mso-hansi-font-family:"Times New Roman"'>函数销毁整个链表，并做一些诸如销毁我们建立的内核进程的收尾工作。</span></p>

<p class=MsoNormal>&nbsp;&nbsp;&nbsp; <span style='font-family:宋体;
mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>下面我们具体看看在程序中该如何保护我们的链表。上述场景中存在的内核并发包括――内核线程之间的并发、内核任务与定时器任务的并发。要知道内核线程执行在进程上下文中，而定时器任务属于下半部分，执行在中断上下文中。在这两部分交错执行中进行保护则需要采用自旋锁。我们例子中使用了</span><span
class=SpellE><span lang=EN-US>spin_lock_bh</span></span><span lang=EN-US>()</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>锁在内核线程的执行路径中对链表进行保护；在下半部分,由于任务队列是串行执行并且不能被内核任务或系统调用打断，所以不必加锁。另外在卸载模块时，删除链表中仍然存在系统调用与下半部分的并发可能，因此也需要按上述方式加锁。</span></p>

<p class=MsoNormal>&nbsp;&nbsp;&nbsp; <span style='font-family:宋体;
mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>除了对共享链表访问使用自旋锁以外，还有两个需要同步的地方，一是计数（</span><span
lang=EN-US>count</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>），该变量属于原子类型，用于记录链表接点的</span><span
lang=EN-US>id</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>。另外一个是利用信号量同步内核创建线程，调度</span><span
class=SpellE><span lang=EN-US>keventd</span></span><span style='font-family:
宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>后执行被堵塞住</span><span
lang=EN-US>(down)</span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>，等内核线程实际启动后</span><span lang=EN-US>,</span><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'> 才可继续执行（</span><span lang=EN-US>up</span><span 
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>）。下面的图给出了<span class=GramE>任务</span>的基本关系和对链表的操作。</span></p>

<p class=MsoNormal style='text-indent:21.75pt'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><!--[if mso & !supportInlineShapes & supportFields]><span
lang=EN-US><span style='mso-element:field-begin;mso-field-lock:yes'></span><span
style='mso-spacerun:yes'>&nbsp;</span>SHAPE<span
style='mso-spacerun:yes'>&nbsp; </span>\* MERGEFORMAT <span style='mso-element:
field-separator'></span></span><![endif]--><span lang=EN-US><!--[if gte vml 1]><v:group
 id="_x0000_s1027" editas="canvas" style='width:453.6pt;height:405.6pt;
 mso-position-horizontal-relative:char;mso-position-vertical-relative:line'
 coordorigin="108,1320" coordsize="9072,8112">
 <o:lock v:ext="edit" aspectratio="t"/>
 <v:shapetype id="_x0000_t75" coordsize="21600,21600" o:spt="75"
  o:preferrelative="t" path="m@4@5l@4@11@9@11@9@5xe" filled="f" stroked="f">
  <v:stroke joinstyle="miter"/>
  <v:formulas>
   <v:f eqn="if lineDrawn pixelLineWidth 0"/>
   <v:f eqn="sum @0 1 0"/>
   <v:f eqn="sum 0 0 @1"/>
   <v:f eqn="prod @2 1 2"/>
   <v:f eqn="prod @3 21600 pixelWidth"/>
   <v:f eqn="prod @3 21600 pixelHeight"/>
   <v:f eqn="sum @0 0 1"/>
   <v:f eqn="prod @6 1 2"/>
   <v:f eqn="prod @7 21600 pixelWidth"/>
   <v:f eqn="sum @8 21600 0"/>
   <v:f eqn="prod @7 21600 pixelHeight"/>
   <v:f eqn="sum @10 21600 0"/>
  </v:formulas>
  <v:path o:extrusionok="f" gradientshapeok="t" o:connecttype="rect"/>
  <o:lock v:ext="edit" aspectratio="t"/>
 </v:shapetype><v:shape id="_x0000_s1026" type="#_x0000_t75" style='position:absolute;
  left:108;top:1320;width:9072;height:8112' o:preferrelative="f">
  <v:fill o:detectmouseclick="t"/>
  <v:path o:extrusionok="t" o:connecttype="none"/>
  <o:lock v:ext="edit" text="t"/>
 </v:shape><v:rect id="_x0000_s1053" style='position:absolute;left:756;top:3210;
  width:2263;height:2649' o:regroupid="1">
  <v:stroke dashstyle="dash"/>
 </v:rect><v:rect id="_x0000_s1050" style='position:absolute;left:3059;top:5880;
  width:4717;height:1524' o:regroupid="1">
  <v:stroke dashstyle="dash"/>
 </v:rect><v:rect id="_x0000_s1028" style='position:absolute;left:938;top:4314;
  width:2009;height:566' o:regroupid="1">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span class=SpellE><span lang=EN-US>share_exit</span></span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:rect><v:rect id="_x0000_s1030" style='position:absolute;left:3059;top:1632;
  width:4717;height:4227' o:regroupid="1">
  <v:stroke dashstyle="dash"/>
 </v:rect><v:rect id="_x0000_s1031" style='position:absolute;left:3560;top:3872;
  width:2008;height:442' o:regroupid="1"/>
 <v:rect id="_x0000_s1032" style='position:absolute;left:3707;top:4021;width:2007;
  height:440' o:regroupid="1"/>
 <v:rect id="_x0000_s1033" style='position:absolute;left:3874;top:4157;width:2008;
  height:440' o:regroupid="1"/>
 <v:rect id="_x0000_s1034" style='position:absolute;left:4012;top:4271;width:2006;
  height:440' o:regroupid="1">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span class=SpellE><span class=GramE><span lang=EN-US>sharelist</span></span></span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:rect><v:rect id="_x0000_s1036" style='position:absolute;left:1503;top:5638;
  width:4567;height:442' o:regroupid="1" fillcolor="#9c0">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span lang=EN-US><span
     style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
     </span></span><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
     mso-hansi-font-family:"Times New Roman"'>链表</span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:rect><v:line id="_x0000_s1037" style='position:absolute' from="3560,4976"
  to="3562,5638" o:regroupid="1">
  <v:stroke endarrow="block"/>
 </v:line><v:line id="_x0000_s1039" style='position:absolute' from="3811,4976"
  to="3813,5638" o:regroupid="1">
  <v:stroke endarrow="block"/>
 </v:line><v:line id="_x0000_s1040" style='position:absolute' from="4062,4976"
  to="4064,5638" o:regroupid="1">
  <v:stroke endarrow="block"/>
 </v:line><v:line id="_x0000_s1041" style='position:absolute' from="4313,4976"
  to="4315,5638" o:regroupid="1">
  <v:stroke endarrow="block"/>
 </v:line><v:line id="_x0000_s1044" style='position:absolute' from="5568,4976"
  to="5569,5638" o:regroupid="1">
  <v:stroke dashstyle="dash" endarrow="block"/>
 </v:line><v:line id="_x0000_s1045" style='position:absolute' from="5317,4976"
  to="5318,5638" o:regroupid="1">
  <v:stroke dashstyle="dash" endarrow="block"/>
 </v:line><v:rect id="_x0000_s1047" style='position:absolute;left:3560;top:6742;
  width:2006;height:440' o:regroupid="1">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span class=SpellE><span lang=EN-US>qt_task</span></span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:rect><v:line id="_x0000_s1052" style='position:absolute;flip:y' from="4564,6080"
  to="4566,6742" o:regroupid="1">
  <v:stroke dashstyle="dash" endarrow="block"/>
 </v:line><v:line id="_x0000_s1054" style='position:absolute' from="1921,4976"
  to="1922,5638" o:regroupid="1">
  <v:stroke dashstyle="dash" endarrow="block"/>
 </v:line><v:rect id="_x0000_s1055" style='position:absolute;left:6270;top:3558;
  width:1440;height:468' o:regroupid="1">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span class=SpellE><span class=GramE><span lang=EN-US>kevent</span></span></span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:rect><v:line id="_x0000_s1057" style='position:absolute;flip:x' from="5760,3816"
  to="6262,3817" o:regroupid="1">
  <v:stroke endarrow="block" endarrowlength="short"/>
 </v:line><v:rect id="_x0000_s1058" style='position:absolute;left:3600;top:1788;
  width:2006;height:440' o:regroupid="1">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span class=SpellE><span lang=EN-US>start_kthread</span></span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:rect><v:shapetype id="_x0000_t202" coordsize="21600,21600" o:spt="202"
  path="m,l,21600r21600,l21600,xe">
  <v:stroke joinstyle="miter"/>
  <v:path gradientshapeok="t" o:connecttype="rect"/>
 </v:shapetype><v:shape id="_x0000_s1069" type="#_x0000_t202" style='position:absolute;
  left:6300;top:5256;width:1440;height:468' strokecolor="white">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
     mso-hansi-font-family:"Times New Roman"'>进程上下文</span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:shape><v:shape id="_x0000_s1070" type="#_x0000_t202" style='position:absolute;
  left:6300;top:6000;width:1440;height:468' strokecolor="white">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
     mso-hansi-font-family:"Times New Roman"'>中断上下文</span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:shape><v:shape id="_x0000_s1071" type="#_x0000_t202" style='position:absolute;
  left:900;top:3348;width:1440;height:468' strokecolor="white">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
     mso-hansi-font-family:"Times New Roman"'>中断上下文</span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:shape><v:shape id="_x0000_s1067" type="#_x0000_t202" style='position:absolute;
  left:3135;top:2724;width:1080;height:468' strokecolor="white">
  <v:textbox style='mso-next-textbox:#_x0000_s1067'>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span class=GramE><span lang=EN-US>down</span></span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:shape><v:shape id="_x0000_s1068" type="#_x0000_t202" style='position:absolute;
  left:5310;top:2705;width:540;height:468' strokecolor="white">
  <v:textbox style='mso-next-textbox:#_x0000_s1068'>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span class=GramE><span lang=EN-US>up</span></span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:shape><v:line id="_x0000_s1072" style='position:absolute' from="4500,2256"
  to="4501,3816">
  <v:stroke endarrow="block"/>
 </v:line><v:shape id="_x0000_s1073" type="#_x0000_t202" style='position:absolute;
  left:4680;top:2256;width:540;height:1560' strokecolor="white">
  <v:textbox style='layout-flow:vertical-ideographic'>
   <![if RotText]><![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span class=SpellE><span lang=EN-US>kernel_thread</span></span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]><![endif]></v:textbox>
 </v:shape><v:line id="_x0000_s1074" style='position:absolute;flip:y' from="3960,2256"
  to="3960,3816">
  <v:stroke dashstyle="1 1" endarrow="open"/>
 </v:line><v:line id="_x0000_s1075" style='position:absolute' from="5220,2271"
  to="5221,3831">
  <v:stroke dashstyle="1 1" endarrow="open"/>
 </v:line><v:shapetype id="_x0000_t5" coordsize="21600,21600" o:spt="5" adj="10800"
  path="m@0,l,21600r21600,xe">
  <v:stroke joinstyle="miter"/>
  <v:formulas>
   <v:f eqn="val #0"/>
   <v:f eqn="prod #0 1 2"/>
   <v:f eqn="sum @1 10800 0"/>
  </v:formulas>
  <v:path gradientshapeok="t" o:connecttype="custom" o:connectlocs="@0,0;@1,10800;0,21600;10800,21600;21600,21600;@2,10800"
   textboxrect="0,10800,10800,18000;5400,10800,16200,18000;10800,10800,21600,18000;0,7200,7200,21600;7200,7200,14400,21600;14400,7200,21600,21600"/>
  <v:handles>
   <v:h position="#0,topLeft" xrange="0,21600"/>
  </v:handles>
 </v:shapetype><v:shape id="_x0000_s1080" type="#_x0000_t5" style='position:absolute;
  left:4680;top:6156;width:180;height:156'/>
 <v:shape id="_x0000_s1079" type="#_x0000_t5" style='position:absolute;left:1620;
  top:5415;width:180;height:156;rotation:180'/>
 <v:shape id="_x0000_s1076" type="#_x0000_t5" style='position:absolute;left:4680;
  top:5406;width:180;height:156;rotation:180'/>
 <v:rect id="_x0000_s1081" style='position:absolute;left:360;top:7560;width:3600;
  height:1716'/>
 <v:shape id="_x0000_s1082" type="#_x0000_t5" style='position:absolute;left:525;
  top:7797;width:180;height:156;rotation:180'/>
 <v:shape id="_x0000_s1083" type="#_x0000_t5" style='position:absolute;left:900;
  top:7803;width:180;height:156'/>
 <v:line id="_x0000_s1084" style='position:absolute' from="540,8349" to="1260,8350">
  <v:stroke endarrow="block"/>
 </v:line><v:line id="_x0000_s1085" style='position:absolute' from="540,8808"
  to="1260,8809">
  <v:stroke dashstyle="dash" endarrow="block"/>
 </v:line><v:shape id="_x0000_s1086" type="#_x0000_t202" style='position:absolute;
  left:1620;top:7656;width:1440;height:468' strokecolor="white">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
     mso-hansi-font-family:"Times New Roman"'>上锁</span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:shape><v:shape id="_x0000_s1087" type="#_x0000_t202" style='position:absolute;
  left:1620;top:8118;width:1440;height:468' strokecolor="white">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
     mso-hansi-font-family:"Times New Roman"'>添加节点</span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:shape><v:shape id="_x0000_s1088" type="#_x0000_t202" style='position:absolute;
  left:1620;top:8586;width:1440;height:468' strokecolor="white">
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
     mso-hansi-font-family:"Times New Roman"'>删除节点</span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:shape><w:wrap type="none" side="left"/>
 <w:anchorlock/>
</v:group><![endif]--><![if !vml]><span style='mso-ignore:vglayout;position:
absolute;z-index:0;margin-left:302px;margin-top:59px;width:42px;height:110px'><![endif]><![if !RotText]><img
width=42 height=110 src="syn.files/image001.gif" alt="文本框: kernel_thread"
v:shapes="_x0000_s1073" class=shape v:dpi="96"><![endif]><![if !vml]></span><img
width=605 height=541 src="syn.files/image002.gif" v:shapes="_x0000_s1027 _x0000_s1026 _x0000_s1053 _x0000_s1050 _x0000_s1028 _x0000_s1030 _x0000_s1031 _x0000_s1032 _x0000_s1033 _x0000_s1034 _x0000_s1036 _x0000_s1037 _x0000_s1039 _x0000_s1040 _x0000_s1041 _x0000_s1044 _x0000_s1045 _x0000_s1047 _x0000_s1052 _x0000_s1054 _x0000_s1055 _x0000_s1057 _x0000_s1058 _x0000_s1069 _x0000_s1070 _x0000_s1071 _x0000_s1067 _x0000_s1068 _x0000_s1072 _x0000_s1074 _x0000_s1075 _x0000_s1080 _x0000_s1079 _x0000_s1076 _x0000_s1081 _x0000_s1082 _x0000_s1083 _x0000_s1084 _x0000_s1085 _x0000_s1086 _x0000_s1087 _x0000_s1088"><![endif]></span><!--[if mso & !supportInlineShapes & supportFields]><span
lang=EN-US><v:shape id="_x0000_i1025" type="#_x0000_t75" style='width:453.6pt;
 height:405.6pt'>
 <v:imagedata croptop="-65520f" cropbottom="65520f"/>
</v:shape><span style='mso-element:field-end'></span></span><![endif]--></p>

<h3><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>结束</span></h3>

<p class=MsoNormal>&nbsp;&nbsp;&nbsp; <span 
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>并发的发生随处都有，但是由它引起的错误可并非每次都有，因为并发过程中引起错误的地方往往就一两步，因此交错执行这一两步要靠“运气”，出错的几率有时很小。但是一旦发生后果都是灾难性的，比如<span
class=GramE>宕</span>机，破坏数据完整性等。所以我们对并发绝不能掉以轻心，必须拿出“把纸老虎当真老虎的”决心来对待一切内核代码中可能的并发，即便在单处理器上编程也需要考虑到移植到多处理器的情况，总之一切都要谨慎小心。</span></p>

<p class=MsoNormal><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>实例代码见</span> <span lang=EN-US><a href="syn.tar">syn.<span class=GramE>tar</span></a></span></p>

</div>

</body>

</html>
